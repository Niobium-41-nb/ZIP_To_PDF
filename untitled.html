<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        <style>
            
        </style>
        <link rel="stylesheet" href="file://C:\Users\14530\AppData\Roaming\npm\node_modules\repo-to-pdf\html5bp/css/normalize.css">
        <link rel="stylesheet" href="file://C:\Users\14530\AppData\Roaming\npm\node_modules\repo-to-pdf\html5bp/css/main.css">
        <link rel="stylesheet" href="file://C:\Users\14530\AppData\Roaming\npm\node_modules\repo-to-pdf\html5bp/css/github-min.css">
        <link rel="stylesheet" href="file://C:\Users\14530\AppData\Roaming\npm\node_modules\repo-to-pdf\html5bp/css/vs.css">
        <script src="file://C:\Users\14530\AppData\Roaming\npm\node_modules\repo-to-pdf\html5bp/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <!-- Add your site or application content here -->
        <article class="markdown-body"><h1 id=. anchor=true>.</h1>
<h2 id=Contents anchor=true>Contents</h2>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;|- ](#apppy) anchor=true><a href="#apppy">    |- </a></h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;|- ](#cleanuppy) anchor=true><a href="#cleanuppy">    |- </a></h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;|- ](#configpy) anchor=true><a href="#configpy">    |- </a></h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>      /</h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;|- ](#flask_zip_to_pdf_project_planmd) anchor=true><a href="#flask_zip_to_pdf_project_planmd">    |- </a></h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>      /</h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;|- ](#READMEmd) anchor=true><a href="#READMEmd">    |- </a></h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;|- ](#requirementstxt) anchor=true><a href="#requirementstxt">    |- </a></h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;|- ](#runpy) anchor=true><a href="#runpy">    |- </a></h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>      /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>          /</h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|- ](#static\js\mainjs) anchor=true><a href="#static\js\mainjs">            |- </a></h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>      /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>              /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                  /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                      /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>              /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                  /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                      /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>              /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                  /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                      /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>              /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                  /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                      /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>              /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                  /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                      /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>                          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>      /</h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|- ](#templates\indexhtml) anchor=true><a href="#templates\indexhtml">        |- </a></h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>      /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>      /</h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|- ](#utils\compressionpy) anchor=true><a href="#utils\compressionpy">        |- </a></h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|- ](#utils\file_utilspy) anchor=true><a href="#utils\file_utilspy">        |- </a></h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|- ](#utils\image_processorpy) anchor=true><a href="#utils\image_processorpy">        |- </a></h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|- ](#utils\pdf_generatorpy) anchor=true><a href="#utils\pdf_generatorpy">        |- </a></h4>
<h4 id=[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|- ](#utils\__init__py) anchor=true><a href="#utils__init__py">        |- </a></h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>          /</h4>
<h4 id=&nbsp;&nbsp;&nbsp;&nbsp;  / anchor=true>      /</h4>
<h4 id=apppy anchor=true>apppy</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> uuid
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, jsonify, send_file
<span class="hljs-keyword">from</span> werkzeug.utils <span class="hljs-keyword">import</span> secure_filename
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> config
<span class="hljs-keyword">from</span> utils.file_utils <span class="hljs-keyword">import</span> FileUtils
<span class="hljs-keyword">from</span> utils.compression <span class="hljs-keyword">import</span> CompressionHandler
<span class="hljs-keyword">from</span> utils.image_processor <span class="hljs-keyword">import</span> ImageProcessor
<span class="hljs-keyword">from</span> utils.pdf_generator <span class="hljs-keyword">import</span> PDFGenerator

<span class="hljs-comment"># 创建Flask应用</span>
app = Flask(__name__)
app.config.from_object(config[<span class="hljs-string">&#x27;default&#x27;</span>])

<span class="hljs-comment"># 全局变量存储处理状态</span>
processing_status = {}
processing_results = {}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessingTask</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;处理任务类&quot;&quot;&quot;</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, task_id</span>):</span>
        self.task_id = task_id
        self.status = <span class="hljs-string">&quot;等待开始&quot;</span>
        self.progress = <span class="hljs-number">0</span>
        self.current_step = <span class="hljs-string">&quot;&quot;</span>
        self.result_files = []
        self.error = <span class="hljs-literal">None</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_status</span>(<span class="hljs-params">self, status, progress=<span class="hljs-literal">None</span>, step=<span class="hljs-literal">None</span></span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;更新任务状态&quot;&quot;&quot;</span>
        self.status = status
        <span class="hljs-keyword">if</span> progress <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.progress = progress
        <span class="hljs-keyword">if</span> step:
            self.current_step = step
        
        <span class="hljs-comment"># 更新全局状态</span>
        processing_status[self.task_id] = {
            <span class="hljs-string">&#x27;status&#x27;</span>: self.status,
            <span class="hljs-string">&#x27;progress&#x27;</span>: self.progress,
            <span class="hljs-string">&#x27;current_step&#x27;</span>: self.current_step,
            <span class="hljs-string">&#x27;error&#x27;</span>: self.error
        }

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_compressed_file</span>(<span class="hljs-params">task_id, file_path, output_dir</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;处理压缩文件的主函数&quot;&quot;&quot;</span>
    task = ProcessingTask(task_id)
    processing_status[task_id] = {
        <span class="hljs-string">&#x27;status&#x27;</span>: <span class="hljs-string">&#x27;等待开始&#x27;</span>,
        <span class="hljs-string">&#x27;progress&#x27;</span>: <span class="hljs-number">0</span>,
        <span class="hljs-string">&#x27;current_step&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,
        <span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-literal">None</span>
    }
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 步骤1: 创建临时目录</span>
        task.update_status(<span class="hljs-string">&quot;创建临时目录&quot;</span>, <span class="hljs-number">5</span>, <span class="hljs-string">&quot;初始化&quot;</span>)
        temp_dir = os.path.join(app.config[<span class="hljs-string">&#x27;TEMP_FOLDER&#x27;</span>], <span class="hljs-string">f&quot;temp_<span class="hljs-subst">{task_id}</span>&quot;</span>)
        os.makedirs(temp_dir, exist_ok=<span class="hljs-literal">True</span>)
        
        <span class="hljs-comment"># 步骤2: 递归解压</span>
        task.update_status(<span class="hljs-string">&quot;开始解压文件&quot;</span>, <span class="hljs-number">10</span>, <span class="hljs-string">&quot;解压&quot;</span>)
        compression_handler = CompressionHandler()
        compression_handler.set_status_callback(
            <span class="hljs-keyword">lambda</span> msg, prog=<span class="hljs-literal">None</span>: task.update_status(msg, prog, <span class="hljs-string">&quot;解压&quot;</span>)
        )
        
        extracted_files = compression_handler.recursive_extract(file_path, temp_dir)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> extracted_files:
            task.update_status(<span class="hljs-string">&quot;解压失败，没有找到文件&quot;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&quot;错误&quot;</span>)
            task.error = <span class="hljs-string">&quot;解压失败，没有找到文件&quot;</span>
            <span class="hljs-keyword">return</span>
        
        task.update_status(<span class="hljs-string">f&quot;解压完成，找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(extracted_files)}</span> 个文件&quot;</span>, <span class="hljs-number">30</span>, <span class="hljs-string">&quot;解压完成&quot;</span>)
        
        <span class="hljs-comment"># 步骤3: 收集和排序图片</span>
        task.update_status(<span class="hljs-string">&quot;收集图片文件&quot;</span>, <span class="hljs-number">40</span>, <span class="hljs-string">&quot;图片处理&quot;</span>)
        image_processor = ImageProcessor()
        image_processor.set_status_callback(
            <span class="hljs-keyword">lambda</span> msg, prog=<span class="hljs-literal">None</span>: task.update_status(msg, prog, <span class="hljs-string">&quot;图片处理&quot;</span>)
        )
        
        image_groups = image_processor.collect_and_sort_images(temp_dir)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image_groups:
            task.update_status(<span class="hljs-string">&quot;没有找到图片文件&quot;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&quot;错误&quot;</span>)
            task.error = <span class="hljs-string">&quot;没有找到图片文件&quot;</span>
            <span class="hljs-keyword">return</span>
        
        task.update_status(<span class="hljs-string">f&quot;找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(image_groups)}</span> 个包含图片的文件夹&quot;</span>, <span class="hljs-number">50</span>, <span class="hljs-string">&quot;图片收集完成&quot;</span>)
        
        <span class="hljs-comment"># 步骤4: 处理图片</span>
        task.update_status(<span class="hljs-string">&quot;处理图片文件&quot;</span>, <span class="hljs-number">60</span>, <span class="hljs-string">&quot;图片优化&quot;</span>)
        processed_image_groups = {}
        <span class="hljs-keyword">for</span> folder_path, image_paths <span class="hljs-keyword">in</span> image_groups.items():
            processed_images = image_processor.process_image_group(image_paths, temp_dir)
            processed_image_groups[folder_path] = processed_images
        
        task.update_status(<span class="hljs-string">&quot;图片处理完成&quot;</span>, <span class="hljs-number">70</span>, <span class="hljs-string">&quot;图片处理完成&quot;</span>)
        
        <span class="hljs-comment"># 步骤5: 生成PDF</span>
        task.update_status(<span class="hljs-string">&quot;生成PDF文件&quot;</span>, <span class="hljs-number">80</span>, <span class="hljs-string">&quot;PDF生成&quot;</span>)
        pdf_generator = PDFGenerator()
        pdf_generator.set_status_callback(
            <span class="hljs-keyword">lambda</span> msg, prog=<span class="hljs-literal">None</span>: task.update_status(msg, prog, <span class="hljs-string">&quot;PDF生成&quot;</span>)
        )
        
        <span class="hljs-comment"># 创建PDF输出目录</span>
        pdf_output_dir = os.path.join(output_dir, <span class="hljs-string">f&quot;pdfs_<span class="hljs-subst">{task_id}</span>&quot;</span>)
        os.makedirs(pdf_output_dir, exist_ok=<span class="hljs-literal">True</span>)
        
        <span class="hljs-comment"># 生成PDF</span>
        generated_pdfs = pdf_generator.generate_pdfs_by_folder(
            processed_image_groups, 
            pdf_output_dir,
            base_name=<span class="hljs-string">&quot;converted&quot;</span>
        )
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> generated_pdfs:
            task.update_status(<span class="hljs-string">&quot;PDF生成失败&quot;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&quot;错误&quot;</span>)
            task.error = <span class="hljs-string">&quot;PDF生成失败&quot;</span>
            <span class="hljs-keyword">return</span>
        
        task.update_status(<span class="hljs-string">f&quot;成功生成 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(generated_pdfs)}</span> 个PDF文件&quot;</span>, <span class="hljs-number">90</span>, <span class="hljs-string">&quot;PDF生成完成&quot;</span>)
        
        <span class="hljs-comment"># 步骤6: 打包结果</span>
        task.update_status(<span class="hljs-string">&quot;打包结果文件&quot;</span>, <span class="hljs-number">95</span>, <span class="hljs-string">&quot;打包&quot;</span>)
        zip_output_path = os.path.join(output_dir, <span class="hljs-string">f&quot;result_<span class="hljs-subst">{task_id}</span>.zip&quot;</span>)
        
        <span class="hljs-keyword">if</span> pdf_generator.create_pdf_package(<span class="hljs-built_in">list</span>(generated_pdfs.values()), zip_output_path):
            task.result_files = [zip_output_path]
            task.update_status(<span class="hljs-string">&quot;处理完成&quot;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&quot;完成&quot;</span>)
        <span class="hljs-keyword">else</span>:
            task.update_status(<span class="hljs-string">&quot;打包失败&quot;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&quot;错误&quot;</span>)
            task.error = <span class="hljs-string">&quot;打包失败&quot;</span>
        
        <span class="hljs-comment"># 存储结果</span>
        processing_results[task_id] = {
            <span class="hljs-string">&#x27;pdf_files&#x27;</span>: <span class="hljs-built_in">list</span>(generated_pdfs.values()),
            <span class="hljs-string">&#x27;zip_file&#x27;</span>: zip_output_path <span class="hljs-keyword">if</span> os.path.exists(zip_output_path) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
        }
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        task.update_status(<span class="hljs-string">f&quot;处理失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&quot;错误&quot;</span>)
        task.error = <span class="hljs-built_in">str</span>(e)
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment"># 清理临时文件（保留输出文件供下载）</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 清理上传文件和临时解压目录</span>
            FileUtils.safe_remove(file_path)  <span class="hljs-comment"># 删除上传的原始文件</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;temp_dir&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">locals</span>():
                FileUtils.safe_remove(temp_dir)  <span class="hljs-comment"># 删除临时解压目录</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> cleanup_error:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;清理临时文件失败: <span class="hljs-subst">{cleanup_error}</span>&quot;</span>)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>():</span>
    <span class="hljs-string">&quot;&quot;&quot;主页&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/upload&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_file</span>():</span>
    <span class="hljs-string">&quot;&quot;&quot;文件上传接口&quot;&quot;&quot;</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 检查文件是否存在</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;file&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> request.files:
            <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;没有选择文件&#x27;</span>}), <span class="hljs-number">400</span>
        
        file = request.files[<span class="hljs-string">&#x27;file&#x27;</span>]
        
        <span class="hljs-comment"># 检查文件名</span>
        <span class="hljs-keyword">if</span> file.filename == <span class="hljs-string">&#x27;&#x27;</span>:
            <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;没有选择文件&#x27;</span>}), <span class="hljs-number">400</span>
        
        <span class="hljs-comment"># 检查文件类型</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> FileUtils.allowed_file(file.filename, app.config[<span class="hljs-string">&#x27;ALLOWED_EXTENSIONS&#x27;</span>]):
            <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;不支持的文件格式&#x27;</span>}), <span class="hljs-number">400</span>
        
        <span class="hljs-comment"># 创建必要的目录</span>
        FileUtils.create_directories()
        
        <span class="hljs-comment"># 生成任务ID</span>
        task_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
        
        <span class="hljs-comment"># 保存上传的文件</span>
        filename = secure_filename(file.filename)
        file_path = os.path.join(app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>], <span class="hljs-string">f&quot;<span class="hljs-subst">{task_id}</span>_<span class="hljs-subst">{filename}</span>&quot;</span>)
        file.save(file_path)
        
        <span class="hljs-comment"># 检查文件大小</span>
        file_size = FileUtils.get_file_size(file_path)
        <span class="hljs-keyword">if</span> file_size &gt; <span class="hljs-number">1024</span>:  <span class="hljs-comment"># 1GB限制</span>
            os.remove(file_path)
            <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;文件大小超过1GB限制&#x27;</span>}), <span class="hljs-number">400</span>
        
        <span class="hljs-comment"># 启动后台处理任务</span>
        output_dir = app.config[<span class="hljs-string">&#x27;OUTPUT_FOLDER&#x27;</span>]
        thread = threading.Thread(
            target=process_compressed_file,
            args=(task_id, file_path, output_dir)
        )
        thread.daemon = <span class="hljs-literal">True</span>
        thread.start()
        
        <span class="hljs-keyword">return</span> jsonify({
            <span class="hljs-string">&#x27;task_id&#x27;</span>: task_id,
            <span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">&#x27;文件上传成功，开始处理&#x27;</span>
        })
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">f&#x27;上传失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&#x27;</span>}), <span class="hljs-number">500</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/status/&lt;task_id&gt;&#x27;</span></span>)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_status</span>(<span class="hljs-params">task_id</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;获取处理状态&quot;&quot;&quot;</span>
    <span class="hljs-keyword">if</span> task_id <span class="hljs-keyword">in</span> processing_status:
        status_info = processing_status[task_id]
        
        <span class="hljs-comment"># 检查是否完成且有结果</span>
        <span class="hljs-keyword">if</span> status_info[<span class="hljs-string">&#x27;status&#x27;</span>] == <span class="hljs-string">&#x27;处理完成&#x27;</span> <span class="hljs-keyword">and</span> task_id <span class="hljs-keyword">in</span> processing_results:
            result = processing_results[task_id]
            status_info[<span class="hljs-string">&#x27;download_url&#x27;</span>] = <span class="hljs-string">f&#x27;/download/<span class="hljs-subst">{task_id}</span>&#x27;</span>
            status_info[<span class="hljs-string">&#x27;pdf_count&#x27;</span>] = <span class="hljs-built_in">len</span>(result.get(<span class="hljs-string">&#x27;pdf_files&#x27;</span>, []))
            status_info[<span class="hljs-string">&#x27;pdf_list_url&#x27;</span>] = <span class="hljs-string">f&#x27;/download/list/<span class="hljs-subst">{task_id}</span>&#x27;</span>
        
        <span class="hljs-keyword">return</span> jsonify(status_info)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;任务不存在&#x27;</span>}), <span class="hljs-number">404</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/download/&lt;task_id&gt;&#x27;</span></span>)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download_result</span>(<span class="hljs-params">task_id</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;下载处理结果（ZIP包）&quot;&quot;&quot;</span>
    <span class="hljs-keyword">if</span> task_id <span class="hljs-keyword">in</span> processing_results:
        result = processing_results[task_id]
        zip_file = result.get(<span class="hljs-string">&#x27;zip_file&#x27;</span>)
        
        <span class="hljs-keyword">if</span> zip_file <span class="hljs-keyword">and</span> os.path.exists(zip_file):
            filename = <span class="hljs-string">f&quot;converted_pdfs_<span class="hljs-subst">{task_id}</span>.zip&quot;</span>
            <span class="hljs-keyword">return</span> send_file(zip_file, as_attachment=<span class="hljs-literal">True</span>, download_name=filename)
    
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;文件不存在或尚未完成&#x27;</span>}), <span class="hljs-number">404</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/download/pdf/&lt;task_id&gt;/&lt;int:pdf_index&gt;&#x27;</span></span>)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download_single_pdf</span>(<span class="hljs-params">task_id, pdf_index</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;下载单个PDF文件&quot;&quot;&quot;</span>
    <span class="hljs-keyword">if</span> task_id <span class="hljs-keyword">in</span> processing_results:
        result = processing_results[task_id]
        pdf_files = result.get(<span class="hljs-string">&#x27;pdf_files&#x27;</span>, [])
        
        <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt;= pdf_index &lt; <span class="hljs-built_in">len</span>(pdf_files):
            pdf_file = pdf_files[pdf_index]
            <span class="hljs-keyword">if</span> os.path.exists(pdf_file):
                filename = os.path.basename(pdf_file)
                <span class="hljs-keyword">return</span> send_file(pdf_file, as_attachment=<span class="hljs-literal">True</span>, download_name=filename)
    
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;PDF文件不存在&#x27;</span>}), <span class="hljs-number">404</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/download/list/&lt;task_id&gt;&#x27;</span></span>)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_pdf_files</span>(<span class="hljs-params">task_id</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;获取PDF文件列表&quot;&quot;&quot;</span>
    <span class="hljs-keyword">if</span> task_id <span class="hljs-keyword">in</span> processing_results:
        result = processing_results[task_id]
        pdf_files = result.get(<span class="hljs-string">&#x27;pdf_files&#x27;</span>, [])
        
        file_list = []
        <span class="hljs-keyword">for</span> i, pdf_file <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(pdf_files):
            <span class="hljs-keyword">if</span> os.path.exists(pdf_file):
                file_info = {
                    <span class="hljs-string">&#x27;index&#x27;</span>: i,
                    <span class="hljs-string">&#x27;filename&#x27;</span>: os.path.basename(pdf_file),
                    <span class="hljs-string">&#x27;size&#x27;</span>: os.path.getsize(pdf_file),
                    <span class="hljs-string">&#x27;download_url&#x27;</span>: <span class="hljs-string">f&#x27;/download/pdf/<span class="hljs-subst">{task_id}</span>/<span class="hljs-subst">{i}</span>&#x27;</span>
                }
                file_list.append(file_info)
        
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;pdf_files&#x27;</span>: file_list})
    
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;任务不存在&#x27;</span>}), <span class="hljs-number">404</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/cleanup&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cleanup_files</span>():</span>
    <span class="hljs-string">&quot;&quot;&quot;清理临时文件&quot;&quot;&quot;</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 清理上传文件</span>
        FileUtils.cleanup_old_files(app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>])
        
        <span class="hljs-comment"># 清理临时文件</span>
        FileUtils.cleanup_old_files(app.config[<span class="hljs-string">&#x27;TEMP_FOLDER&#x27;</span>])
        
        <span class="hljs-comment"># 清理输出文件（保留时间更长）</span>
        FileUtils.cleanup_old_files(app.config[<span class="hljs-string">&#x27;OUTPUT_FOLDER&#x27;</span>], hours_old=<span class="hljs-number">48</span>)
        
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">&#x27;清理完成&#x27;</span>})
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">f&#x27;清理失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&#x27;</span>}), <span class="hljs-number">500</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/cleanup/task/&lt;task_id&gt;&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cleanup_task_files</span>(<span class="hljs-params">task_id</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;清理指定任务的所有文件&quot;&quot;&quot;</span>
    <span class="hljs-keyword">try</span>:
        FileUtils.cleanup_task_files(
            task_id,
            app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>],
            app.config[<span class="hljs-string">&#x27;TEMP_FOLDER&#x27;</span>],
            app.config[<span class="hljs-string">&#x27;OUTPUT_FOLDER&#x27;</span>]
        )
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">f&#x27;任务 <span class="hljs-subst">{task_id}</span> 文件清理完成&#x27;</span>})
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">f&#x27;清理失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&#x27;</span>}), <span class="hljs-number">500</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
    <span class="hljs-comment"># 创建必要的目录</span>
    FileUtils.create_directories()
    
    <span class="hljs-comment"># 启动应用</span>
    app.run(debug=<span class="hljs-literal">True</span>, host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">5000</span>)
</code></pre>
<h4 id=cleanuppy anchor=true>cleanuppy</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-string">&quot;&quot;&quot;
文件清理脚本
用于清理上传文件、临时文件和旧的输出文件
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> config
<span class="hljs-keyword">from</span> utils.file_utils <span class="hljs-keyword">import</span> FileUtils

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cleanup_all_files</span>():</span>
    <span class="hljs-string">&quot;&quot;&quot;清理所有临时和旧文件&quot;&quot;&quot;</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始清理所有文件...&quot;</span>)
    
    config_obj = config[<span class="hljs-string">&#x27;default&#x27;</span>]
    
    <span class="hljs-comment"># 确保目录存在</span>
    FileUtils.create_directories()
    
    <span class="hljs-comment"># 清理上传文件夹（保留24小时内的文件）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;清理上传文件夹...&quot;</span>)
    FileUtils.cleanup_old_files(config_obj.UPLOAD_FOLDER, hours_old=<span class="hljs-number">24</span>)
    
    <span class="hljs-comment"># 清理临时文件夹（保留12小时内的文件）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;清理临时文件夹...&quot;</span>)
    FileUtils.cleanup_old_files(config_obj.TEMP_FOLDER, hours_old=<span class="hljs-number">12</span>)
    
    <span class="hljs-comment"># 清理输出文件夹（保留48小时内的文件）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;清理输出文件夹...&quot;</span>)
    FileUtils.cleanup_old_files(config_obj.OUTPUT_FOLDER, hours_old=<span class="hljs-number">48</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;文件清理完成！&quot;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cleanup_task_files</span>(<span class="hljs-params">task_id</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;清理指定任务的所有文件&quot;&quot;&quot;</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;清理任务 <span class="hljs-subst">{task_id}</span> 的文件...&quot;</span>)
    
    config_obj = config[<span class="hljs-string">&#x27;default&#x27;</span>]
    FileUtils.cleanup_task_files(
        task_id,
        config_obj.UPLOAD_FOLDER,
        config_obj.TEMP_FOLDER,
        config_obj.OUTPUT_FOLDER
    )

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show_file_stats</span>():</span>
    <span class="hljs-string">&quot;&quot;&quot;显示文件统计信息&quot;&quot;&quot;</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n文件统计信息:&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">40</span>)
    
    config_obj = config[<span class="hljs-string">&#x27;default&#x27;</span>]
    
    <span class="hljs-keyword">for</span> folder_name, folder_path <span class="hljs-keyword">in</span> [
        (<span class="hljs-string">&quot;上传文件夹&quot;</span>, config_obj.UPLOAD_FOLDER),
        (<span class="hljs-string">&quot;临时文件夹&quot;</span>, config_obj.TEMP_FOLDER),
        (<span class="hljs-string">&quot;输出文件夹&quot;</span>, config_obj.OUTPUT_FOLDER)
    ]:
        <span class="hljs-keyword">if</span> os.path.exists(folder_path):
            files = os.listdir(folder_path)
            total_size = <span class="hljs-number">0</span>
            
            <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:
                file_path = os.path.join(folder_path, file)
                <span class="hljs-keyword">if</span> os.path.isfile(file_path):
                    total_size += os.path.getsize(file_path)
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">{folder_name}</span>: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(files)}</span> 个文件, <span class="hljs-subst">{total_size / (<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>):<span class="hljs-number">.2</span>f}</span> MB&quot;</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">{folder_name}</span>: 目录不存在&quot;</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;压缩包转PDF工具 - 文件清理脚本&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>)
    
    <span class="hljs-comment"># 显示当前文件状态</span>
    show_file_stats()
    
    <span class="hljs-comment"># 询问用户要执行的操作</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n请选择操作:&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1. 清理所有临时和旧文件&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;2. 清理指定任务的文件&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;3. 仅显示文件统计&quot;</span>)
    
    choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入选择 (1-3): &quot;</span>).strip()
    
    <span class="hljs-keyword">if</span> choice == <span class="hljs-string">&#x27;1&#x27;</span>:
        cleanup_all_files()
    <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;2&#x27;</span>:
        task_id = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入任务ID: &quot;</span>).strip()
        <span class="hljs-keyword">if</span> task_id:
            cleanup_task_files(task_id)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;无效的任务ID&quot;</span>)
    <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;3&#x27;</span>:
        show_file_stats()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;无效的选择&quot;</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n操作完成！&quot;</span>)
</code></pre>
<h4 id=configpy anchor=true>configpy</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-python"><span class="hljs-keyword">import</span> os

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span>:</span>
    <span class="hljs-comment"># 基础配置</span>
    SECRET_KEY = os.environ.get(<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;dev-secret-key&#x27;</span>
    
    <span class="hljs-comment"># 文件上传配置</span>
    MAX_CONTENT_LENGTH = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>  <span class="hljs-comment"># 1GB</span>
    UPLOAD_FOLDER = <span class="hljs-string">&#x27;uploads&#x27;</span>
    TEMP_FOLDER = <span class="hljs-string">&#x27;temp&#x27;</span>
    OUTPUT_FOLDER = <span class="hljs-string">&#x27;outputs&#x27;</span>
    
    <span class="hljs-comment"># 允许的压缩文件扩展名</span>
    ALLOWED_EXTENSIONS = {
        <span class="hljs-string">&#x27;zip&#x27;</span>, <span class="hljs-string">&#x27;tar&#x27;</span>, <span class="hljs-string">&#x27;gz&#x27;</span>, <span class="hljs-string">&#x27;bz2&#x27;</span>, <span class="hljs-string">&#x27;rar&#x27;</span>, <span class="hljs-string">&#x27;7z&#x27;</span>, <span class="hljs-string">&#x27;tar.gz&#x27;</span>, <span class="hljs-string">&#x27;tar.bz2&#x27;</span>
    }
    
    <span class="hljs-comment"># 允许的图片文件扩展名</span>
    ALLOWED_IMAGE_EXTENSIONS = {
        <span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>, <span class="hljs-string">&#x27;png&#x27;</span>, <span class="hljs-string">&#x27;gif&#x27;</span>, <span class="hljs-string">&#x27;bmp&#x27;</span>, <span class="hljs-string">&#x27;webp&#x27;</span>
    }
    
    <span class="hljs-comment"># PDF配置</span>
    PDF_PAGE_SIZE = <span class="hljs-string">&#x27;A4&#x27;</span>
    PDF_ORIENTATION = <span class="hljs-string">&#x27;portrait&#x27;</span>  <span class="hljs-comment"># portrait 或 landscape</span>
    
    <span class="hljs-comment"># 清理配置（小时）</span>
    CLEANUP_INTERVAL = <span class="hljs-number">24</span>  <span class="hljs-comment"># 24小时后清理临时文件</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DevelopmentConfig</span>(<span class="hljs-params">Config</span>):</span>
    DEBUG = <span class="hljs-literal">True</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductionConfig</span>(<span class="hljs-params">Config</span>):</span>
    DEBUG = <span class="hljs-literal">False</span>

config = {
    <span class="hljs-string">&#x27;development&#x27;</span>: DevelopmentConfig,
    <span class="hljs-string">&#x27;production&#x27;</span>: ProductionConfig,
    <span class="hljs-string">&#x27;default&#x27;</span>: DevelopmentConfig
}
</code></pre>
<h4 id=flask_zip_to_pdf_project_planmd anchor=true>flask_zip_to_pdf_project_planmd</h4>
<p><a href="#Contents">to top</a></p>
<h1 id=Flask压缩包转PDF项目详细计划 anchor=true>Flask压缩包转PDF项目详细计划</h1>
<h2 id=项目概述 anchor=true>项目概述</h2>
<p>创建一个Python Flask Web应用，能够处理嵌套压缩包，提取其中的图片文件，并按文件夹分组生成A4竖排的PDF文件。</p>
<h2 id=技术规格 anchor=true>技术规格</h2>
<h3 id=技术栈 anchor=true>技术栈</h3>
<ul>
<li><strong>后端框架</strong>: Python Flask</li>
<li><strong>压缩包处理</strong>: zipfile, tarfile, rarfile, py7zr</li>
<li><strong>图片处理</strong>: Pillow (PIL)</li>
<li><strong>PDF生成</strong>: img2pdf</li>
<li><strong>文件类型检测</strong>: python-magic</li>
<li><strong>前端</strong>: HTML5, CSS3, JavaScript (原生)</li>
<li><strong>进度显示</strong>: Server-Sent Events (SSE)</li>
</ul>
<h3 id=支持的文件格式 anchor=true>支持的文件格式</h3>
<ul>
<li><strong>压缩格式</strong>: .zip, .tar.gz, .tar.bz2, .rar, .7z</li>
<li><strong>图片格式</strong>: .webp, .jpg, .jpeg, .png, .gif, .bmp</li>
</ul>
<h2 id=项目架构 anchor=true>项目架构</h2>
<h3 id=系统架构图 anchor=true>系统架构图</h3>
<pre><code class="language-mermaid">graph TB
    subgraph &quot;前端界面&quot;
        <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[文件上传表单]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[进度显示]</span>
        <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[结果下载]</span>
    end
    
    subgraph &quot;Flask后端&quot;
        D<span class="hljs-selector-attr">[文件接收]</span> --&gt; E<span class="hljs-selector-attr">[文件验证]</span>
        E --&gt; F<span class="hljs-selector-attr">[递归解压]</span>
        F --&gt; G<span class="hljs-selector-attr">[图片收集]</span>
        G --&gt; H<span class="hljs-selector-attr">[PDF生成]</span>
        H --&gt; <span class="hljs-selector-tag">I</span><span class="hljs-selector-attr">[结果打包]</span>
    end
    
    subgraph &quot;文件系统&quot;
        J<span class="hljs-selector-attr">[uploads/]</span> --&gt; K<span class="hljs-selector-attr">[temp/]</span>
        K --&gt; L<span class="hljs-selector-attr">[outputs/]</span>
    end
    
    <span class="hljs-selector-tag">A</span> --&gt; D
    <span class="hljs-selector-tag">I</span> --&gt; C
    F --&gt; M<span class="hljs-selector-attr">[状态更新]</span>
    M --&gt; <span class="hljs-selector-tag">B</span>
</code></pre>
<h3 id=目录结构 anchor=true>目录结构</h3>
<pre><code>zip_to_pdf_app/
├── app.py                    <span class="hljs-meta"># Flask主应用</span>
├── requirements.txt          <span class="hljs-meta"># Python依赖包</span>
├── config.py                <span class="hljs-meta"># 配置文件</span>
├── utils/                   <span class="hljs-meta"># 工具模块</span>
│   ├── __init__.py
│   ├── file_utils.py        <span class="hljs-meta"># 文件处理工具</span>
│   ├── compression.py       <span class="hljs-meta"># 压缩包处理</span>
│   ├── image_processor.py   <span class="hljs-meta"># 图片处理</span>
│   └── pdf_generator.py     <span class="hljs-meta"># PDF生成</span>
├── <span class="hljs-keyword">static</span>/
│   ├── css/
│   │   └── style.css        <span class="hljs-meta"># 样式文件</span>
│   └── js/
│       └── main.js          <span class="hljs-meta"># 前端JavaScript</span>
├── templates/
│   └── <span class="hljs-keyword">index</span>.html           <span class="hljs-meta"># 主页面模板</span>
├── uploads/                 <span class="hljs-meta"># 上传文件临时存储</span>
├── temp/                    <span class="hljs-meta"># 解压临时目录</span>
└── outputs/                 <span class="hljs-meta"># 生成的PDF文件</span>
</code></pre>
<h2 id=核心功能模块详细设计 anchor=true>核心功能模块详细设计</h2>
<h3 id=1. 文件上传模块 (app.py) anchor=true>1. 文件上传模块 (app.py)</h3>
<pre><code class="language-python"><span class="hljs-comment"># 主要功能：</span>
- 接收multipart/form-data文件上传
- 文件大小验证（最大1GB）
- 文件类型验证（支持的压缩格式）
- 实时上传进度显示
- 文件存储到uploads目录
</code></pre>
<h3 id=2. 递归解压模块 (utils/compression.py) anchor=true>2. 递归解压模块 (utils/compression.py)</h3>
<pre><code class="language-python"><span class="hljs-comment"># 主要功能：</span>
- 自动检测压缩包格式
- 递归解压嵌套压缩包
- 保持原始目录结构
- 实时解压状态跟踪
- 临时文件管理
</code></pre>
<h3 id=3. 图片处理模块 (utils/image_processor.py) anchor=true>3. 图片处理模块 (utils/image_processor.py)</h3>
<pre><code class="language-python"><span class="hljs-comment"># 主要功能：</span>
- 图片文件识别和过滤
- 按文件名自然排序
- 图片格式转换（如webp转png）
- 图片质量优化
- 按文件夹分组图片
</code></pre>
<h3 id=4. PDF生成模块 (utils/pdf_generator.py) anchor=true>4. PDF生成模块 (utils/pdf_generator.py)</h3>
<pre><code class="language-python"><span class="hljs-comment"># 主要功能：</span>
- A4竖排页面设置
- 图片自适应页面大小
- 按文件夹生成多个PDF
- PDF文件命名和存储
- 生成结果打包
</code></pre>
<h3 id=5. 前端界面模块 anchor=true>5. 前端界面模块</h3>
<pre><code class="language-html"><span class="hljs-comment">&lt;!-- 主要功能： --&gt;</span>
- 拖拽文件上传界面
- 实时进度条显示
- 解压状态实时更新
- 下载链接生成
- 响应式设计
</code></pre>
<h2 id=详细实现步骤 anchor=true>详细实现步骤</h2>
<h3 id=阶段1: 项目基础设置 (预计时间: 1小时) anchor=true>阶段1: 项目基础设置 (预计时间: 1小时)</h3>
<ol>
<li>创建项目目录结构</li>
<li>配置requirements.txt依赖包</li>
<li>设置Flask应用基础配置</li>
<li>创建必要的目录结构</li>
</ol>
<h3 id=阶段2: 文件上传功能 (预计时间: 2小时) anchor=true>阶段2: 文件上传功能 (预计时间: 2小时)</h3>
<ol>
<li>实现Flask文件上传路由</li>
<li>添加文件验证逻辑</li>
<li>实现上传进度显示</li>
<li>测试文件上传功能</li>
</ol>
<h3 id=阶段3: 递归解压功能 (预计时间: 3小时) anchor=true>阶段3: 递归解压功能 (预计时间: 3小时)</h3>
<ol>
<li>实现多种压缩格式支持</li>
<li>开发递归解压算法</li>
<li>添加解压状态跟踪</li>
<li>测试嵌套压缩包处理</li>
</ol>
<h3 id=阶段4: 图片处理和PDF生成 (预计时间: 2小时) anchor=true>阶段4: 图片处理和PDF生成 (预计时间: 2小时)</h3>
<ol>
<li>实现图片文件识别和排序</li>
<li>开发PDF生成逻辑</li>
<li>按文件夹分组处理</li>
<li>测试PDF生成功能</li>
</ol>
<h3 id=阶段5: 前端界面开发 (预计时间: 2小时) anchor=true>阶段5: 前端界面开发 (预计时间: 2小时)</h3>
<ol>
<li>创建用户友好的上传界面</li>
<li>实现实时进度更新</li>
<li>添加下载功能</li>
<li>优化用户体验</li>
</ol>
<h3 id=阶段6: 集成测试和优化 (预计时间: 2小时) anchor=true>阶段6: 集成测试和优化 (预计时间: 2小时)</h3>
<ol>
<li>端到端功能测试</li>
<li>性能优化和错误处理</li>
<li>内存泄漏检查</li>
<li>用户体验优化</li>
</ol>
<h2 id=关键算法设计 anchor=true>关键算法设计</h2>
<h3 id=递归解压算法 anchor=true>递归解压算法</h3>
<pre><code class="language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">recursive_extract</span>(<span class="hljs-params">file_path, extract_to, status_callback</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;
    递归解压压缩包
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># 1. 检测文件类型</span>
    <span class="hljs-comment"># 2. 解压到临时目录</span>
    <span class="hljs-comment"># 3. 遍历解压后的文件</span>
    <span class="hljs-comment"># 4. 对每个文件检测是否为压缩包</span>
    <span class="hljs-comment"># 5. 如果是压缩包，递归调用</span>
    <span class="hljs-comment"># 6. 更新解压状态</span>
</code></pre>
<h3 id=图片收集和排序算法 anchor=true>图片收集和排序算法</h3>
<pre><code class="language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collect_and_sort_images</span>(<span class="hljs-params">root_dir</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;
    收集并排序图片文件
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># 1. 遍历目录结构</span>
    <span class="hljs-comment"># 2. 识别图片文件</span>
    <span class="hljs-comment"># 3. 按文件夹分组</span>
    <span class="hljs-comment"># 4. 按文件名自然排序</span>
    <span class="hljs-comment"># 5. 返回分组后的图片列表</span>
</code></pre>
<h2 id=配置要求 anchor=true>配置要求</h2>
<h3 id=系统要求 anchor=true>系统要求</h3>
<ul>
<li>Python 3.8+</li>
<li>足够磁盘空间（至少2GB空闲）</li>
<li>内存：建议4GB+</li>
</ul>
<h3 id=Python依赖包 anchor=true>Python依赖包</h3>
<pre><code><span class="hljs-attribute">Flask</span>==<span class="hljs-number">2</span>.<span class="hljs-number">3</span>.<span class="hljs-number">3</span>
<span class="hljs-attribute">Pillow</span>==<span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>
<span class="hljs-attribute">img2pdf</span>==<span class="hljs-number">0</span>.<span class="hljs-number">4</span>.<span class="hljs-number">4</span>
<span class="hljs-attribute">python</span>-magic==<span class="hljs-number">0</span>.<span class="hljs-number">4</span>.<span class="hljs-number">27</span>
<span class="hljs-attribute">rarfile</span>==<span class="hljs-number">4</span>.<span class="hljs-number">0</span>
<span class="hljs-attribute">py7zr</span>==<span class="hljs-number">0</span>.<span class="hljs-number">20</span>.<span class="hljs-number">4</span>
</code></pre>
<h2 id=测试计划 anchor=true>测试计划</h2>
<h3 id=功能测试 anchor=true>功能测试</h3>
<ol>
<li>单层压缩包处理</li>
<li>多层嵌套压缩包处理</li>
<li>多种图片格式支持</li>
<li>大文件处理（接近1GB）</li>
<li>错误文件处理</li>
</ol>
<h3 id=性能测试 anchor=true>性能测试</h3>
<ol>
<li>解压速度测试</li>
<li>内存使用监控</li>
<li>并发处理测试</li>
<li>磁盘空间管理</li>
</ol>
<h2 id=部署说明 anchor=true>部署说明</h2>
<h3 id=本地开发运行 anchor=true>本地开发运行</h3>
<pre><code class="language-bash"><span class="hljs-comment"># 安装依赖</span>
pip install -r requirements.txt

<span class="hljs-comment"># 运行应用</span>
python app.py
</code></pre>
<h3 id=访问地址 anchor=true>访问地址</h3>
<p>http://localhost:5000</p>
<h2 id=风险管理和应对措施 anchor=true>风险管理和应对措施</h2>
<h3 id=技术风险 anchor=true>技术风险</h3>
<ol>
<li><strong>内存溢出</strong>: 使用流式处理，及时清理临时文件</li>
<li><strong>文件损坏</strong>: 添加文件验证和错误恢复机制</li>
<li><strong>格式不支持</strong>: 提供清晰的错误提示信息</li>
</ol>
<h3 id=用户体验风险 anchor=true>用户体验风险</h3>
<ol>
<li><strong>长时间等待</strong>: 提供详细的进度信息</li>
<li><strong>操作复杂</strong>: 简化界面设计，提供明确指引</li>
</ol>
<h2 id=成功标准 anchor=true>成功标准</h2>
<ul>
<li>支持所有指定的压缩和图片格式</li>
<li>正确处理嵌套压缩包</li>
<li>按文件夹生成正确的PDF文件</li>
<li>提供良好的用户体验</li>
<li>稳定处理1GB以内的文件</li>
</ul>
<p>这个计划涵盖了项目的所有关键方面，从技术实现到用户体验，确保项目能够成功交付。</p>
<h4 id=READMEmd anchor=true>READMEmd</h4>
<p><a href="#Contents">to top</a></p>
<h1 id=Flask压缩包转PDF工具 anchor=true>Flask压缩包转PDF工具</h1>
<p>一个基于Python Flask的Web应用，能够处理嵌套压缩包，提取其中的图片文件，并按文件夹分组生成A4竖排的PDF文件。</p>
<h2 id=功能特性 anchor=true>功能特性</h2>
<ul>
<li>✅ <strong>支持多种压缩格式</strong>: ZIP, TAR, RAR, 7Z (包括.tar.gz, .tar.bz2)</li>
<li>✅ <strong>嵌套压缩包处理</strong>: 自动递归解压多层嵌套的压缩包</li>
<li>✅ <strong>多种图片格式支持</strong>: JPG, PNG, WEBP, GIF, BMP</li>
<li>✅ <strong>按文件夹分组</strong>: 保持原始目录结构，按文件夹生成多个PDF</li>
<li>✅ <strong>保持图片顺序</strong>: 按文件名自然排序，保持图片原始顺序</li>
<li>✅ <strong>A4竖排PDF</strong>: 生成标准A4尺寸的PDF文件</li>
<li>✅ <strong>实时进度显示</strong>: 上传、解压、处理、生成全过程进度显示</li>
<li>✅ <strong>大文件支持</strong>: 支持最大1GB的压缩包</li>
<li>✅ <strong>用户友好界面</strong>: 现代化的Web界面，支持拖拽上传</li>
<li>✅ <strong>灵活的下载选项</strong>: 支持完整包下载和单个PDF文件下载</li>
<li>✅ <strong>自动文件清理</strong>: 处理完成后自动清理临时文件，避免磁盘占用</li>
</ul>
<h2 id=项目结构 anchor=true>项目结构</h2>
<pre><code>zip_to_pdf_app/
├── app.py                    <span class="hljs-meta"># Flask主应用</span>
├── cleanup.py                <span class="hljs-meta"># 文件清理脚本</span>
├── requirements.txt          <span class="hljs-meta"># Python依赖包</span>
├── config.py                <span class="hljs-meta"># 配置文件</span>
├── README.md                <span class="hljs-meta"># 项目说明文档</span>
├── utils/                   <span class="hljs-meta"># 工具模块</span>
│   ├── __init__.py
│   ├── file_utils.py        <span class="hljs-meta"># 文件处理工具</span>
│   ├── compression.py       <span class="hljs-meta"># 压缩包处理</span>
│   ├── image_processor.py   <span class="hljs-meta"># 图片处理</span>
│   └── pdf_generator.py     <span class="hljs-meta"># PDF生成</span>
├── <span class="hljs-keyword">static</span>/
│   ├── css/
│   │   └── style.css        <span class="hljs-meta"># 样式文件</span>
│   └── js/
│       └── main.js          <span class="hljs-meta"># 前端JavaScript</span>
├── templates/
│   └── <span class="hljs-keyword">index</span>.html           <span class="hljs-meta"># 主页面模板</span>
├── uploads/                 <span class="hljs-meta"># 上传文件临时存储</span>
├── temp/                    <span class="hljs-meta"># 解压临时目录</span>
└── outputs/                 <span class="hljs-meta"># 生成的PDF文件</span>
</code></pre>
<h2 id=安装和运行 anchor=true>安装和运行</h2>
<h3 id=1. 安装依赖 anchor=true>1. 安装依赖</h3>
<pre><code class="language-bash">pip install -r requirements.txt
</code></pre>
<h3 id=2. 运行应用 anchor=true>2. 运行应用</h3>
<pre><code class="language-bash">python app.py
</code></pre>
<h3 id=3. 访问应用 anchor=true>3. 访问应用</h3>
<p>打开浏览器访问: http://localhost:5000</p>
<h2 id=使用说明 anchor=true>使用说明</h2>
<ol>
<li><strong>上传压缩包</strong>: 点击选择文件或拖拽压缩包到上传区域</li>
<li><strong>等待处理</strong>: 系统会自动解压、处理图片并生成PDF</li>
<li><strong>下载结果</strong>: 处理完成后选择下载方式：
<ul>
<li><strong>完整包下载</strong>: 下载包含所有PDF的ZIP文件</li>
<li><strong>单独下载</strong>: 在PDF文件列表中单独下载需要的PDF</li>
</ul></li>
</ol>
<h2 id=下载结果 anchor=true>下载结果</h2>
<p>处理完成后，系统提供多种下载方式：</p>
<h3 id=1. 完整下载 anchor=true>1. 完整下载</h3>
<ul>
<li>下载包含所有PDF文件的ZIP压缩包</li>
<li>适合批量下载所有转换结果</li>
</ul>
<h3 id=2. 单独下载 anchor=true>2. 单独下载</h3>
<ul>
<li>查看生成的PDF文件列表</li>
<li>单独下载每个PDF文件</li>
<li>适合只需要部分文件的情况</li>
</ul>
<h3 id=下载功能特点： anchor=true>下载功能特点：</h3>
<ul>
<li><strong>ZIP包下载</strong>: 一键下载所有PDF文件</li>
<li><strong>PDF列表</strong>: 显示每个PDF文件的详细信息（文件名、大小）</li>
<li><strong>单独下载</strong>: 点击即可下载单个PDF文件</li>
<li><strong>响应式设计</strong>: 在手机和电脑上都能良好显示</li>
</ul>
<h2 id=文件清理机制 anchor=true>文件清理机制</h2>
<h3 id=自动清理 anchor=true>自动清理</h3>
<ul>
<li><strong>上传文件</strong>: 处理完成后立即删除原始上传文件</li>
<li><strong>临时文件</strong>: 处理完成后立即删除解压的临时文件</li>
<li><strong>输出文件</strong>: 保留48小时供下载，之后自动清理</li>
</ul>
<h3 id=手动清理 anchor=true>手动清理</h3>
<p>使用清理脚本管理文件：</p>
<pre><code class="language-bash"><span class="hljs-comment"># 运行清理脚本</span>
python cleanup.py

<span class="hljs-comment"># 选项：</span>
<span class="hljs-comment"># 1. 清理所有临时和旧文件</span>
<span class="hljs-comment"># 2. 清理指定任务的文件  </span>
<span class="hljs-comment"># 3. 显示文件统计信息</span>
</code></pre>
<h3 id=API清理接口 anchor=true>API清理接口</h3>
<ul>
<li><code>POST /cleanup</code> - 清理所有临时文件</li>
<li><code>POST /cleanup/task/&lt;task_id&gt;</code> - 清理指定任务的所有文件</li>
</ul>
<h2 id=技术栈 anchor=true>技术栈</h2>
<ul>
<li><strong>后端</strong>: Python Flask</li>
<li><strong>文件处理</strong>: zipfile, tarfile, rarfile, py7zr</li>
<li><strong>图片处理</strong>: Pillow (PIL)</li>
<li><strong>PDF生成</strong>: img2pdf</li>
<li><strong>文件类型检测</strong>: mimetypes (Python内置)</li>
<li><strong>前端</strong>: HTML5, CSS3, JavaScript (原生)</li>
</ul>
<h2 id=配置说明 anchor=true>配置说明</h2>
<p>在 <code>config.py</code> 中可以修改以下配置：</p>
<ul>
<li><strong>文件大小限制</strong>: 默认1GB</li>
<li><strong>支持的压缩格式</strong>: ZIP, TAR, RAR, 7Z等</li>
<li><strong>支持的图片格式</strong>: JPG, PNG, WEBP等</li>
<li><strong>PDF页面设置</strong>: A4竖排</li>
<li><strong>临时文件清理</strong>: 24小时自动清理</li>
</ul>
<h2 id=API接口 anchor=true>API接口</h2>
<h3 id=POST /upload anchor=true>POST /upload</h3>
<p>文件上传接口</p>
<ul>
<li>参数: file (压缩包文件)</li>
<li>返回: task_id (任务ID)</li>
</ul>
<h3 id=GET /status/<task_id> anchor=true>GET /status/&lt;task_id&gt;</h3>
<p>获取处理状态</p>
<ul>
<li>返回: 处理进度、状态信息</li>
</ul>
<h3 id=GET /download/<task_id> anchor=true>GET /download/&lt;task_id&gt;</h3>
<p>下载处理结果（ZIP包）</p>
<ul>
<li>返回: PDF文件包ZIP</li>
</ul>
<h3 id=GET /download/list/<task_id> anchor=true>GET /download/list/&lt;task_id&gt;</h3>
<p>获取PDF文件列表</p>
<ul>
<li>返回: PDF文件信息列表</li>
</ul>
<h3 id=GET /download/pdf/<task_id>/<pdf_index> anchor=true>GET /download/pdf/&lt;task_id&gt;/&lt;pdf_index&gt;</h3>
<p>下载单个PDF文件</p>
<ul>
<li>返回: 指定的PDF文件</li>
</ul>
<h3 id=POST /cleanup anchor=true>POST /cleanup</h3>
<p>清理临时文件</p>
<h3 id=POST /cleanup/task/<task_id> anchor=true>POST /cleanup/task/&lt;task_id&gt;</h3>
<p>清理指定任务的所有文件</p>
<h2 id=处理流程 anchor=true>处理流程</h2>
<ol>
<li><strong>文件上传</strong>: 接收并验证压缩包文件</li>
<li><strong>递归解压</strong>: 自动解压所有嵌套压缩包</li>
<li><strong>图片收集</strong>: 按文件夹分组收集图片文件</li>
<li><strong>图片处理</strong>: 格式转换和尺寸优化</li>
<li><strong>PDF生成</strong>: 按文件夹生成多个PDF文件</li>
<li><strong>结果打包</strong>: 将所有PDF打包成ZIP文件</li>
<li><strong>文件下载</strong>: 提供多种下载选项</li>
<li><strong>自动清理</strong>: 处理完成后清理临时文件</li>
</ol>
<h2 id=注意事项 anchor=true>注意事项</h2>
<ul>
<li>确保有足够的磁盘空间处理大文件</li>
<li>临时文件会自动清理，避免磁盘空间占用</li>
<li>支持中文字符的文件名和路径</li>
<li>建议在本地网络环境中使用</li>
</ul>
<h2 id=故障排除 anchor=true>故障排除</h2>
<h3 id=常见问题 anchor=true>常见问题</h3>
<ol>
<li><p><strong>文件上传失败</strong></p>
<ul>
<li>检查文件大小是否超过1GB限制</li>
<li>检查文件格式是否支持</li>
</ul></li>
<li><p><strong>解压失败</strong></p>
<ul>
<li>检查压缩包是否损坏</li>
<li>检查是否受密码保护</li>
</ul></li>
<li><p><strong>PDF生成失败</strong></p>
<ul>
<li>检查图片文件是否损坏</li>
<li>检查磁盘空间是否充足</li>
</ul></li>
<li><p><strong>磁盘空间不足</strong></p>
<ul>
<li>运行清理脚本释放空间</li>
<li>手动删除不需要的输出文件</li>
</ul></li>
</ol>
<h3 id=日志查看 anchor=true>日志查看</h3>
<p>应用运行时的错误信息会在控制台输出，可以据此进行故障诊断。</p>
<h2 id=许可证 anchor=true>许可证</h2>
<p>MIT License</p>
<h2 id=贡献 anchor=true>贡献</h2>
<p>欢迎提交Issue和Pull Request来改进这个项目。</p>
<h4 id=requirementstxt anchor=true>requirementstxt</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-plaintext">Flask==2.3.3
Pillow==10.0.0
img2pdf==0.4.4
rarfile==4.0
py7zr==0.20.4
Werkzeug==2.3.7
</code></pre>
<h4 id=runpy anchor=true>runpy</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-string">&quot;&quot;&quot;
Flask压缩包转PDF工具 - 启动脚本
&quot;&quot;&quot;</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> webbrowser
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> utils.file_utils <span class="hljs-keyword">import</span> FileUtils

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_dependencies</span>():</span>
    <span class="hljs-string">&quot;&quot;&quot;检查必要的依赖包&quot;&quot;&quot;</span>
    required_packages = [
        <span class="hljs-string">&#x27;flask&#x27;</span>,
        <span class="hljs-string">&#x27;pillow&#x27;</span>,
        <span class="hljs-string">&#x27;img2pdf&#x27;</span>, 
        <span class="hljs-string">&#x27;python-magic&#x27;</span>,
        <span class="hljs-string">&#x27;rarfile&#x27;</span>,
        <span class="hljs-string">&#x27;py7zr&#x27;</span>
    ]
    
    missing_packages = []
    
    <span class="hljs-keyword">for</span> package <span class="hljs-keyword">in</span> required_packages:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-built_in">__import__</span>(package.replace(<span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-string">&#x27;_&#x27;</span>))
        <span class="hljs-keyword">except</span> ImportError:
            missing_packages.append(package)
    
    <span class="hljs-keyword">if</span> missing_packages:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;缺少必要的依赖包:&quot;</span>)
        <span class="hljs-keyword">for</span> package <span class="hljs-keyword">in</span> missing_packages:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  - <span class="hljs-subst">{package}</span>&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n请运行以下命令安装依赖:&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;pip install -r requirements.txt&quot;</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">open_browser</span>():</span>
    <span class="hljs-string">&quot;&quot;&quot;在浏览器中打开应用&quot;&quot;&quot;</span>
    time.sleep(<span class="hljs-number">2</span>)  <span class="hljs-comment"># 等待应用启动</span>
    webbrowser.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;http://localhost:5000&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-string">&quot;&quot;&quot;主函数&quot;&quot;&quot;</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Flask压缩包转PDF工具&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>)
    
    <span class="hljs-comment"># 检查依赖</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;检查依赖包...&quot;</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_dependencies():
        sys.exit(<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 创建必要目录</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;创建项目目录...&quot;</span>)
    FileUtils.create_directories()
    
    <span class="hljs-comment"># 导入并启动Flask应用</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> app
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;启动Flask应用...&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;应用地址: http://localhost:5000&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;按 Ctrl+C 停止应用&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)
        
        <span class="hljs-comment"># 在浏览器中打开应用</span>
        browser_thread = threading.Thread(target=open_browser)
        browser_thread.daemon = <span class="hljs-literal">True</span>
        browser_thread.start()
        
        <span class="hljs-comment"># 启动Flask应用</span>
        app.run(debug=<span class="hljs-literal">True</span>, host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">5000</span>, use_reloader=<span class="hljs-literal">False</span>)
        
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n应用已停止&quot;</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;启动失败: <span class="hljs-subst">{e}</span>&quot;</span>)
        sys.exit(<span class="hljs-number">1</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
    main()
</code></pre>
<h4 id=static\js\mainjs anchor=true>static\js\mainjs</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-javascript"><span class="hljs-comment">// 主要JavaScript功能增强</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZipToPDFApp</span> </span>{
    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>.currentTaskId = <span class="hljs-literal">null</span>;
        <span class="hljs-built_in">this</span>.statusCheckInterval = <span class="hljs-literal">null</span>;
        <span class="hljs-built_in">this</span>.initializeEventListeners();
    }

    <span class="hljs-function"><span class="hljs-title">initializeEventListeners</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-comment">// 文件拖拽事件</span>
        <span class="hljs-keyword">const</span> uploadArea = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;uploadArea&#x27;</span>);
        <span class="hljs-keyword">const</span> fileInput = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;fileInput&#x27;</span>);

        <span class="hljs-keyword">if</span> (uploadArea &amp;&amp; fileInput) {
            <span class="hljs-built_in">this</span>.setupDragAndDrop(uploadArea, fileInput);
            <span class="hljs-built_in">this</span>.setupFileInput(fileInput);
        }

        <span class="hljs-comment">// 清理按钮事件（如果有的话）</span>
        <span class="hljs-keyword">const</span> cleanupBtn = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;cleanupBtn&#x27;</span>);
        <span class="hljs-keyword">if</span> (cleanupBtn) {
            cleanupBtn.addEventListener(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">this</span>.cleanupFiles());
        }
    }

    <span class="hljs-function"><span class="hljs-title">setupDragAndDrop</span>(<span class="hljs-params">uploadArea, fileInput</span>)</span> {
        <span class="hljs-comment">// 阻止默认拖拽行为</span>
        [<span class="hljs-string">&#x27;dragenter&#x27;</span>, <span class="hljs-string">&#x27;dragover&#x27;</span>, <span class="hljs-string">&#x27;dragleave&#x27;</span>, <span class="hljs-string">&#x27;drop&#x27;</span>].forEach(<span class="hljs-function"><span class="hljs-params">eventName</span> =&gt;</span> {
            uploadArea.addEventListener(eventName, <span class="hljs-built_in">this</span>.preventDefaults, <span class="hljs-literal">false</span>);
            <span class="hljs-built_in">document</span>.body.addEventListener(eventName, <span class="hljs-built_in">this</span>.preventDefaults, <span class="hljs-literal">false</span>);
        });

        <span class="hljs-comment">// 高亮拖拽区域</span>
        [<span class="hljs-string">&#x27;dragenter&#x27;</span>, <span class="hljs-string">&#x27;dragover&#x27;</span>].forEach(<span class="hljs-function"><span class="hljs-params">eventName</span> =&gt;</span> {
            uploadArea.addEventListener(eventName, <span class="hljs-function">() =&gt;</span> {
                uploadArea.classList.add(<span class="hljs-string">&#x27;dragover&#x27;</span>);
            }, <span class="hljs-literal">false</span>);
        });

        [<span class="hljs-string">&#x27;dragleave&#x27;</span>, <span class="hljs-string">&#x27;drop&#x27;</span>].forEach(<span class="hljs-function"><span class="hljs-params">eventName</span> =&gt;</span> {
            uploadArea.addEventListener(eventName, <span class="hljs-function">() =&gt;</span> {
                uploadArea.classList.remove(<span class="hljs-string">&#x27;dragover&#x27;</span>);
            }, <span class="hljs-literal">false</span>);
        });

        <span class="hljs-comment">// 处理文件放置</span>
        uploadArea.addEventListener(<span class="hljs-string">&#x27;drop&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> files = e.dataTransfer.files;
            <span class="hljs-keyword">if</span> (files.length &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-built_in">this</span>.handleFile(files[<span class="hljs-number">0</span>]);
            }
        }, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-function"><span class="hljs-title">setupFileInput</span>(<span class="hljs-params">fileInput</span>)</span> {
        fileInput.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (e.target.files.length &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-built_in">this</span>.handleFile(e.target.files[<span class="hljs-number">0</span>]);
            }
        });
    }

    <span class="hljs-function"><span class="hljs-title">preventDefaults</span>(<span class="hljs-params">e</span>)</span> {
        e.preventDefault();
        e.stopPropagation();
    }

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">handleFile</span>(<span class="hljs-params">file</span>)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-built_in">this</span>.resetUI();
            
            <span class="hljs-comment">// 验证文件</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.validateFile(file)) {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// 显示文件信息</span>
            <span class="hljs-built_in">this</span>.showFileInfo(file);

            <span class="hljs-comment">// 显示进度容器</span>
            <span class="hljs-built_in">this</span>.showProgressContainer(<span class="hljs-string">&#x27;正在上传文件...&#x27;</span>);

            <span class="hljs-comment">// 上传文件</span>
            <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> FormData();
            formData.append(<span class="hljs-string">&#x27;file&#x27;</span>, file);

            <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&#x27;/upload&#x27;</span>, {
                <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
                <span class="hljs-attr">body</span>: formData
            });

            <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.json();

            <span class="hljs-keyword">if</span> (data.error) {
                <span class="hljs-built_in">this</span>.showError(data.error);
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-built_in">this</span>.currentTaskId = data.task_id;
            <span class="hljs-built_in">this</span>.showProgressContainer(<span class="hljs-string">&#x27;文件上传成功，开始处理...&#x27;</span>);
            
            <span class="hljs-comment">// 开始轮询状态</span>
            <span class="hljs-built_in">this</span>.startStatusPolling();

        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-built_in">this</span>.showError(<span class="hljs-string">&#x27;上传失败: &#x27;</span> + error.message);
            <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&#x27;File upload error:&#x27;</span>, error);
        }
    }

    <span class="hljs-function"><span class="hljs-title">validateFile</span>(<span class="hljs-params">file</span>)</span> {
        <span class="hljs-keyword">const</span> allowedExtensions = [<span class="hljs-string">&#x27;zip&#x27;</span>, <span class="hljs-string">&#x27;tar&#x27;</span>, <span class="hljs-string">&#x27;gz&#x27;</span>, <span class="hljs-string">&#x27;bz2&#x27;</span>, <span class="hljs-string">&#x27;rar&#x27;</span>, <span class="hljs-string">&#x27;7z&#x27;</span>, <span class="hljs-string">&#x27;tar.gz&#x27;</span>, <span class="hljs-string">&#x27;tar.bz2&#x27;</span>];
        <span class="hljs-keyword">const</span> fileExtension = file.name.split(<span class="hljs-string">&#x27;.&#x27;</span>).pop().toLowerCase();
        <span class="hljs-keyword">const</span> doubleExtension = file.name.split(<span class="hljs-string">&#x27;.&#x27;</span>).slice(-<span class="hljs-number">2</span>).join(<span class="hljs-string">&#x27;.&#x27;</span>).toLowerCase();

        <span class="hljs-keyword">if</span> (!allowedExtensions.includes(fileExtension) &amp;&amp; !allowedExtensions.includes(doubleExtension)) {
            <span class="hljs-built_in">this</span>.showError(<span class="hljs-string">&#x27;不支持的文件格式。请上传ZIP、TAR、RAR或7Z格式的文件。&#x27;</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">// 验证文件大小 (1GB = 1024MB)</span>
        <span class="hljs-keyword">if</span> (file.size &gt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) {
            <span class="hljs-built_in">this</span>.showError(<span class="hljs-string">&#x27;文件大小超过1GB限制。&#x27;</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-title">showFileInfo</span>(<span class="hljs-params">file</span>)</span> {
        <span class="hljs-keyword">const</span> fileSizeMB = (file.size / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)).toFixed(<span class="hljs-number">2</span>);
        
        <span class="hljs-comment">// 可以在这里添加显示文件信息的逻辑</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`文件信息: <span class="hljs-subst">${file.name}</span>, 大小: <span class="hljs-subst">${fileSizeMB}</span> MB`</span>);
    }

    <span class="hljs-function"><span class="hljs-title">showProgressContainer</span>(<span class="hljs-params">message</span>)</span> {
        <span class="hljs-keyword">const</span> progressContainer = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressContainer&#x27;</span>);
        <span class="hljs-keyword">const</span> statusMessage = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;statusMessage&#x27;</span>);
        
        <span class="hljs-keyword">if</span> (progressContainer &amp;&amp; statusMessage) {
            progressContainer.style.display = <span class="hljs-string">&#x27;block&#x27;</span>;
            statusMessage.style.display = <span class="hljs-string">&#x27;block&#x27;</span>;
            statusMessage.textContent = message;
        }
    }

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">startStatusPolling</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.statusCheckInterval) {
            <span class="hljs-built_in">clearInterval</span>(<span class="hljs-built_in">this</span>.statusCheckInterval);
        }

        <span class="hljs-built_in">this</span>.statusCheckInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">async</span> () =&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">`/status/<span class="hljs-subst">${<span class="hljs-built_in">this</span>.currentTaskId}</span>`</span>);
                <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.json();

                <span class="hljs-keyword">if</span> (data.error) {
                    <span class="hljs-built_in">this</span>.stopStatusPolling();
                    <span class="hljs-built_in">this</span>.showError(data.error);
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-built_in">this</span>.updateProgress(data);

                <span class="hljs-keyword">if</span> (data.status === <span class="hljs-string">&#x27;完成&#x27;</span>) {
                    <span class="hljs-built_in">this</span>.stopStatusPolling();
                    <span class="hljs-built_in">this</span>.showResult(data);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.error) {
                    <span class="hljs-built_in">this</span>.stopStatusPolling();
                    <span class="hljs-built_in">this</span>.showError(data.error);
                }

            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&#x27;Status check error:&#x27;</span>, error);
            }
        }, <span class="hljs-number">1000</span>);
    }

    <span class="hljs-function"><span class="hljs-title">stopStatusPolling</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.statusCheckInterval) {
            <span class="hljs-built_in">clearInterval</span>(<span class="hljs-built_in">this</span>.statusCheckInterval);
            <span class="hljs-built_in">this</span>.statusCheckInterval = <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-function"><span class="hljs-title">updateProgress</span>(<span class="hljs-params">data</span>)</span> {
        <span class="hljs-keyword">const</span> progressFill = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressFill&#x27;</span>);
        <span class="hljs-keyword">const</span> progressText = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressText&#x27;</span>);
        <span class="hljs-keyword">const</span> statusText = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;statusText&#x27;</span>);
        <span class="hljs-keyword">const</span> statusMessage = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;statusMessage&#x27;</span>);

        <span class="hljs-keyword">if</span> (progressFill) progressFill.style.width = data.progress + <span class="hljs-string">&#x27;%&#x27;</span>;
        <span class="hljs-keyword">if</span> (progressText) progressText.textContent = data.progress + <span class="hljs-string">&#x27;%&#x27;</span>;
        <span class="hljs-keyword">if</span> (statusText) statusText.textContent = data.current_step;
        <span class="hljs-keyword">if</span> (statusMessage) statusMessage.textContent = data.status;
    }

    <span class="hljs-function"><span class="hljs-title">showResult</span>(<span class="hljs-params">data</span>)</span> {
        <span class="hljs-keyword">const</span> progressContainer = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressContainer&#x27;</span>);
        <span class="hljs-keyword">const</span> resultContainer = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;resultContainer&#x27;</span>);
        <span class="hljs-keyword">const</span> downloadBtn = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;downloadBtn&#x27;</span>);

        <span class="hljs-keyword">if</span> (progressContainer) progressContainer.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;
        <span class="hljs-keyword">if</span> (resultContainer) resultContainer.style.display = <span class="hljs-string">&#x27;block&#x27;</span>;

        <span class="hljs-keyword">if</span> (downloadBtn &amp;&amp; data.download_url) {
            downloadBtn.href = data.download_url;
            
            <span class="hljs-comment">// 添加点击事件统计</span>
            downloadBtn.addEventListener(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-built_in">this</span>.trackDownload(data.pdf_count || <span class="hljs-number">1</span>);
            });
        }

        <span class="hljs-comment">// 显示成功消息</span>
        <span class="hljs-built_in">this</span>.showSuccessMessage(<span class="hljs-string">`成功生成 <span class="hljs-subst">${data.pdf_count || <span class="hljs-number">1</span>}</span> 个PDF文件`</span>);
    }

    <span class="hljs-function"><span class="hljs-title">showError</span>(<span class="hljs-params">message</span>)</span> {
        <span class="hljs-keyword">const</span> progressContainer = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressContainer&#x27;</span>);
        <span class="hljs-keyword">const</span> errorMessage = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;errorMessage&#x27;</span>);

        <span class="hljs-keyword">if</span> (progressContainer) progressContainer.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;
        <span class="hljs-keyword">if</span> (errorMessage) {
            errorMessage.style.display = <span class="hljs-string">&#x27;block&#x27;</span>;
            errorMessage.textContent = message;
        }
    }

    <span class="hljs-function"><span class="hljs-title">showSuccessMessage</span>(<span class="hljs-params">message</span>)</span> {
        <span class="hljs-comment">// 可以在这里添加成功消息的显示逻辑</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Success:&#x27;</span>, message);
    }

    <span class="hljs-function"><span class="hljs-title">resetUI</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">const</span> elements = {
            <span class="hljs-attr">progressContainer</span>: <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressContainer&#x27;</span>),
            <span class="hljs-attr">errorMessage</span>: <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;errorMessage&#x27;</span>),
            <span class="hljs-attr">resultContainer</span>: <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;resultContainer&#x27;</span>),
            <span class="hljs-attr">progressFill</span>: <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressFill&#x27;</span>),
            <span class="hljs-attr">progressText</span>: <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressText&#x27;</span>),
            <span class="hljs-attr">statusText</span>: <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;statusText&#x27;</span>)
        };

        <span class="hljs-comment">// 隐藏所有状态容器</span>
        <span class="hljs-keyword">if</span> (elements.progressContainer) elements.progressContainer.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;
        <span class="hljs-keyword">if</span> (elements.errorMessage) elements.errorMessage.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;
        <span class="hljs-keyword">if</span> (elements.resultContainer) elements.resultContainer.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;

        <span class="hljs-comment">// 重置进度</span>
        <span class="hljs-keyword">if</span> (elements.progressFill) elements.progressFill.style.width = <span class="hljs-string">&#x27;0%&#x27;</span>;
        <span class="hljs-keyword">if</span> (elements.progressText) elements.progressText.textContent = <span class="hljs-string">&#x27;0%&#x27;</span>;
        <span class="hljs-keyword">if</span> (elements.statusText) elements.statusText.textContent = <span class="hljs-string">&#x27;等待开始&#x27;</span>;

        <span class="hljs-comment">// 停止轮询</span>
        <span class="hljs-built_in">this</span>.stopStatusPolling();
        <span class="hljs-built_in">this</span>.currentTaskId = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">cleanupFiles</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&#x27;/cleanup&#x27;</span>, {
                <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>
            });

            <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.json();

            <span class="hljs-keyword">if</span> (data.error) {
                alert(<span class="hljs-string">&#x27;清理失败: &#x27;</span> + data.error);
            } <span class="hljs-keyword">else</span> {
                alert(<span class="hljs-string">&#x27;临时文件清理完成&#x27;</span>);
            }
        } <span class="hljs-keyword">catch</span> (error) {
            alert(<span class="hljs-string">&#x27;清理请求失败: &#x27;</span> + error.message);
        }
    }

    <span class="hljs-function"><span class="hljs-title">trackDownload</span>(<span class="hljs-params">pdfCount</span>)</span> {
        <span class="hljs-comment">// 可以在这里添加下载统计逻辑</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`用户下载了 <span class="hljs-subst">${pdfCount}</span> 个PDF文件`</span>);
    }
}

<span class="hljs-comment">// 工具函数</span>
<span class="hljs-keyword">const</span> Utils = {
    <span class="hljs-function"><span class="hljs-title">formatFileSize</span>(<span class="hljs-params">bytes</span>)</span> {
        <span class="hljs-keyword">if</span> (bytes === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;0 Bytes&#x27;</span>;
        
        <span class="hljs-keyword">const</span> k = <span class="hljs-number">1024</span>;
        <span class="hljs-keyword">const</span> sizes = [<span class="hljs-string">&#x27;Bytes&#x27;</span>, <span class="hljs-string">&#x27;KB&#x27;</span>, <span class="hljs-string">&#x27;MB&#x27;</span>, <span class="hljs-string">&#x27;GB&#x27;</span>];
        <span class="hljs-keyword">const</span> i = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.log(bytes) / <span class="hljs-built_in">Math</span>.log(k));
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>((bytes / <span class="hljs-built_in">Math</span>.pow(k, i)).toFixed(<span class="hljs-number">2</span>)) + <span class="hljs-string">&#x27; &#x27;</span> + sizes[i];
    },

    <span class="hljs-function"><span class="hljs-title">formatTime</span>(<span class="hljs-params">seconds</span>)</span> {
        <span class="hljs-keyword">const</span> minutes = <span class="hljs-built_in">Math</span>.floor(seconds / <span class="hljs-number">60</span>);
        <span class="hljs-keyword">const</span> remainingSeconds = seconds % <span class="hljs-number">60</span>;
        
        <span class="hljs-keyword">if</span> (minutes &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${minutes}</span>分<span class="hljs-subst">${remainingSeconds}</span>秒`</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${remainingSeconds}</span>秒`</span>;
        }
    },

    <span class="hljs-function"><span class="hljs-title">debounce</span>(<span class="hljs-params">func, wait</span>)</span> {
        <span class="hljs-keyword">let</span> timeout;
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">executedFunction</span>(<span class="hljs-params">...args</span>) </span>{
            <span class="hljs-keyword">const</span> later = <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-built_in">clearTimeout</span>(timeout);
                func(...args);
            };
            <span class="hljs-built_in">clearTimeout</span>(timeout);
            timeout = <span class="hljs-built_in">setTimeout</span>(later, wait);
        };
    }
};

<span class="hljs-comment">// 页面加载完成后初始化应用</span>
<span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">&#x27;DOMContentLoaded&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">window</span>.zipToPDFApp = <span class="hljs-keyword">new</span> ZipToPDFApp();
    
    <span class="hljs-comment">// 添加页面卸载时的清理</span>
    <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">&#x27;beforeunload&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.zipToPDFApp) {
            <span class="hljs-built_in">window</span>.zipToPDFApp.stopStatusPolling();
        }
    });
});

<span class="hljs-comment">// 导出供其他脚本使用</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="hljs-built_in">module</span>.exports) {
    <span class="hljs-built_in">module</span>.exports = { ZipToPDFApp, Utils };
}
</code></pre>
<h4 id=templates\indexhtml anchor=true>templates\indexhtml</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;zh-CN&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>压缩包转PDF工具<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">box-sizing</span>: border-box;
        }
        
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">font-family</span>: <span class="hljs-string">&#x27;Segoe UI&#x27;</span>, Tahoma, Geneva, Verdana, sans-serif;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#764ba2</span> <span class="hljs-number">100%</span>);
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
        }
        
        <span class="hljs-selector-class">.container</span> {
            <span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-number">40px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
            <span class="hljs-attribute">overflow</span>: hidden;
        }
        
        <span class="hljs-selector-class">.header</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#4facfe</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#00f2fe</span> <span class="hljs-number">100%</span>);
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">text-align</span>: center;
        }
        
        <span class="hljs-selector-class">.header</span> <span class="hljs-selector-tag">h1</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2.5em</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">300</span>;
        }
        
        <span class="hljs-selector-class">.header</span> <span class="hljs-selector-tag">p</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.1em</span>;
            <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.9</span>;
        }
        
        <span class="hljs-selector-class">.content</span> {
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">40px</span>;
        }
        
        <span class="hljs-selector-class">.upload-area</span> {
            <span class="hljs-attribute">border</span>: <span class="hljs-number">3px</span> dashed <span class="hljs-number">#4facfe</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8f9fa</span>;
        }
        
        <span class="hljs-selector-class">.upload-area</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#667eea</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#e9ecef</span>;
        }
        
        <span class="hljs-selector-class">.upload-area</span><span class="hljs-selector-class">.dragover</span> {
            <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#667eea</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#e3f2fd</span>;
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.02</span>);
        }
        
        <span class="hljs-selector-class">.upload-icon</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">4em</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#4facfe</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
        }
        
        <span class="hljs-selector-class">.upload-text</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.2em</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#495057</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>;
        }
        
        <span class="hljs-selector-class">.file-input</span> {
            <span class="hljs-attribute">display</span>: none;
        }
        
        <span class="hljs-selector-class">.upload-btn</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#4facfe</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#00f2fe</span> <span class="hljs-number">100%</span>);
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">border</span>: none;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span> <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">25px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.1em</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
        }
        
        <span class="hljs-selector-class">.upload-btn</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>);
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">79</span>, <span class="hljs-number">172</span>, <span class="hljs-number">254</span>, <span class="hljs-number">0.3</span>);
        }
        
        <span class="hljs-selector-class">.upload-btn</span><span class="hljs-selector-pseudo">:disabled</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#6c757d</span>;
            <span class="hljs-attribute">cursor</span>: not-allowed;
            <span class="hljs-attribute">transform</span>: none;
            <span class="hljs-attribute">box-shadow</span>: none;
        }
        
        <span class="hljs-selector-class">.progress-container</span> {
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">display</span>: none;
        }
        
        <span class="hljs-selector-class">.progress-bar</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#e9ecef</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
        }
        
        <span class="hljs-selector-class">.progress-fill</span> {
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#4facfe</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#00f2fe</span> <span class="hljs-number">100%</span>);
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">transition</span>: width <span class="hljs-number">0.3s</span> ease;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">0%</span>;
        }
        
        <span class="hljs-selector-class">.progress-text</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: space-between;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.9em</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#6c757d</span>;
        }
        
        <span class="hljs-selector-class">.status-message</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#e7f3ff</span>;
            <span class="hljs-attribute">border-left</span>: <span class="hljs-number">4px</span> solid <span class="hljs-number">#4facfe</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
            <span class="hljs-attribute">display</span>: none;
        }
        
        <span class="hljs-selector-class">.result-container</span> {
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">display</span>: none;
        }
        
        <span class="hljs-selector-class">.download-btn</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#28a745</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#20c997</span> <span class="hljs-number">100%</span>);
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">border</span>: none;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span> <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">25px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.2em</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
            <span class="hljs-attribute">text-decoration</span>: none;
            <span class="hljs-attribute">display</span>: inline-block;
        }
        
        <span class="hljs-selector-class">.download-btn</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>);
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">40</span>, <span class="hljs-number">167</span>, <span class="hljs-number">69</span>, <span class="hljs-number">0.3</span>);
        }

        <span class="hljs-selector-class">.pdf-list-container</span> {
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">display</span>: none;
        }

        <span class="hljs-selector-class">.pdf-list</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8f9fa</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">max-height</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">overflow-y</span>: auto;
        }

        <span class="hljs-selector-class">.pdf-item</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: space-between;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span> <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e9ecef</span>;
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
        }

        <span class="hljs-selector-class">.pdf-item</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#4facfe</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">8px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">79</span>, <span class="hljs-number">172</span>, <span class="hljs-number">254</span>, <span class="hljs-number">0.1</span>);
        }

        <span class="hljs-selector-class">.pdf-info</span> {
            <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
        }

        <span class="hljs-selector-class">.pdf-name</span> {
            <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">500</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#495057</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">5px</span>;
        }

        <span class="hljs-selector-class">.pdf-size</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.9em</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#6c757d</span>;
        }

        <span class="hljs-selector-class">.pdf-download-btn</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#4facfe</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#00f2fe</span> <span class="hljs-number">100%</span>);
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">border</span>: none;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.9em</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
            <span class="hljs-attribute">text-decoration</span>: none;
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
        }

        <span class="hljs-selector-class">.pdf-download-btn</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">1px</span>);
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-number">15px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">79</span>, <span class="hljs-number">172</span>, <span class="hljs-number">254</span>, <span class="hljs-number">0.3</span>);
        }
        
        <span class="hljs-selector-class">.error-message</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8d7da</span>;
            <span class="hljs-attribute">border-left</span>: <span class="hljs-number">4px</span> solid <span class="hljs-number">#dc3545</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#721c24</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
            <span class="hljs-attribute">display</span>: none;
        }
        
        <span class="hljs-selector-class">.supported-formats</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8f9fa</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">30px</span>;
        }
        
        <span class="hljs-selector-class">.formats-grid</span> {
            <span class="hljs-attribute">display</span>: grid;
            grid-template-<span class="hljs-attribute">columns</span>: <span class="hljs-built_in">repeat</span>(auto-fit, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">150px</span>, <span class="hljs-number">1</span>fr));
            gap: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">15px</span>;
        }
        
        <span class="hljs-selector-class">.format-item</span> {
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#dee2e6</span>;
        }
        
        <span class="hljs-selector-class">.format-label</span> {
            <span class="hljs-attribute">font-weight</span>: bold;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#495057</span>;
        }
        
        <span class="hljs-selector-class">.format-ext</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#6c757d</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.9em</span>;
        }
        
        <span class="hljs-selector-class">.loading</span> {
            <span class="hljs-attribute">display</span>: inline-block;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">3px</span> solid <span class="hljs-number">#f3f3f3</span>;
            <span class="hljs-attribute">border-top</span>: <span class="hljs-number">3px</span> solid <span class="hljs-number">#4facfe</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">animation</span>: spin <span class="hljs-number">1s</span> linear infinite;
        }
        
        <span class="hljs-keyword">@keyframes</span> spin {
            <span class="hljs-number">0%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">0deg</span>); }
            <span class="hljs-number">100%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">360deg</span>); }
        }
        
        <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
            <span class="hljs-selector-class">.container</span> {
                <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span>;
            }
            
            <span class="hljs-selector-class">.content</span> {
                <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            }
            
            <span class="hljs-selector-class">.header</span> <span class="hljs-selector-tag">h1</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2em</span>;
            }

            <span class="hljs-selector-class">.pdf-item</span> {
                <span class="hljs-attribute">flex-direction</span>: column;
                <span class="hljs-attribute">align-items</span>: flex-start;
                gap: <span class="hljs-number">10px</span>;
            }

            <span class="hljs-selector-class">.pdf-download-btn</span> {
                <span class="hljs-attribute">align-self</span>: flex-end;
            }
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;header&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>压缩包转PDF工具<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>上传压缩包，自动解压并将图片转换为PDF<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;upload-area&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;uploadArea&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;upload-icon&quot;</span>&gt;</span>📁<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;upload-text&quot;</span>&gt;</span>拖拽文件到此处或点击选择文件<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color: #6c757d; margin-bottom: 20px;&quot;</span>&gt;</span>支持 ZIP, TAR, RAR, 7Z 等格式<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;fileInput&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;file-input&quot;</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">&quot;.zip,.tar,.gz,.bz2,.rar,.7z,.tar.gz,.tar.bz2&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;upload-btn&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;document.getElementById(&#x27;fileInput&#x27;).click()&quot;</span>&gt;</span>选择文件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;progress-container&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;progressContainer&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;progress-bar&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;progress-fill&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;progressFill&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;progress-text&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;progressText&quot;</span>&gt;</span>0%<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;statusText&quot;</span>&gt;</span>等待开始<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;status-message&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;statusMessage&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;error-message&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;errorMessage&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;result-container&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;resultContainer&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;text-align: center;&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color: #28a745; margin-bottom: 20px;&quot;</span>&gt;</span>处理完成！<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;download-btn&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;downloadBtn&quot;</span>&gt;</span>下载PDF文件包<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;pdf-list-container&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pdfListContainer&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;margin-top: 30px; display: none;&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color: #495057; margin-bottom: 15px;&quot;</span>&gt;</span>生成的PDF文件：<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;pdf-list&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pdfList&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;supported-formats&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>支持的文件格式<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;formats-grid&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-item&quot;</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-label&quot;</span>&gt;</span>压缩格式<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-ext&quot;</span>&gt;</span>ZIP, TAR, RAR, 7Z<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-item&quot;</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-label&quot;</span>&gt;</span>图片格式<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-ext&quot;</span>&gt;</span>JPG, PNG, WEBP, GIF, BMP<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-item&quot;</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-label&quot;</span>&gt;</span>最大文件<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-ext&quot;</span>&gt;</span>1 GB<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-item&quot;</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-label&quot;</span>&gt;</span>输出格式<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-ext&quot;</span>&gt;</span>A4 PDF<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">let</span> currentTaskId = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">let</span> statusCheckInterval = <span class="hljs-literal">null</span>;
        
        <span class="hljs-comment">// 获取DOM元素</span>
        <span class="hljs-keyword">const</span> uploadArea = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;uploadArea&#x27;</span>);
        <span class="hljs-keyword">const</span> fileInput = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;fileInput&#x27;</span>);
        <span class="hljs-keyword">const</span> progressContainer = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressContainer&#x27;</span>);
        <span class="hljs-keyword">const</span> progressFill = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressFill&#x27;</span>);
        <span class="hljs-keyword">const</span> progressText = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;progressText&#x27;</span>);
        <span class="hljs-keyword">const</span> statusText = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;statusText&#x27;</span>);
        <span class="hljs-keyword">const</span> statusMessage = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;statusMessage&#x27;</span>);
        <span class="hljs-keyword">const</span> errorMessage = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;errorMessage&#x27;</span>);
        <span class="hljs-keyword">const</span> resultContainer = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;resultContainer&#x27;</span>);
        <span class="hljs-keyword">const</span> downloadBtn = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;downloadBtn&#x27;</span>);
        <span class="hljs-keyword">const</span> pdfListContainer = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;pdfListContainer&#x27;</span>);
        <span class="hljs-keyword">const</span> pdfList = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;pdfList&#x27;</span>);
        
        <span class="hljs-comment">// 拖拽事件处理</span>
        uploadArea.addEventListener(<span class="hljs-string">&#x27;dragover&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            e.preventDefault();
            uploadArea.classList.add(<span class="hljs-string">&#x27;dragover&#x27;</span>);
        });
        
        uploadArea.addEventListener(<span class="hljs-string">&#x27;dragleave&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
            uploadArea.classList.remove(<span class="hljs-string">&#x27;dragover&#x27;</span>);
        });
        
        uploadArea.addEventListener(<span class="hljs-string">&#x27;drop&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            e.preventDefault();
            uploadArea.classList.remove(<span class="hljs-string">&#x27;dragover&#x27;</span>);
            
            <span class="hljs-keyword">const</span> files = e.dataTransfer.files;
            <span class="hljs-keyword">if</span> (files.length &gt; <span class="hljs-number">0</span>) {
                handleFile(files[<span class="hljs-number">0</span>]);
            }
        });
        
        <span class="hljs-comment">// 文件选择事件</span>
        fileInput.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (e.target.files.length &gt; <span class="hljs-number">0</span>) {
                handleFile(e.target.files[<span class="hljs-number">0</span>]);
            }
        });
        
        <span class="hljs-comment">// 处理文件上传</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleFile</span>(<span class="hljs-params">file</span>) </span>{
            <span class="hljs-comment">// 重置状态</span>
            resetUI();
            
            <span class="hljs-comment">// 验证文件类型</span>
            <span class="hljs-keyword">const</span> allowedExtensions = [<span class="hljs-string">&#x27;zip&#x27;</span>, <span class="hljs-string">&#x27;tar&#x27;</span>, <span class="hljs-string">&#x27;gz&#x27;</span>, <span class="hljs-string">&#x27;bz2&#x27;</span>, <span class="hljs-string">&#x27;rar&#x27;</span>, <span class="hljs-string">&#x27;7z&#x27;</span>, <span class="hljs-string">&#x27;tar.gz&#x27;</span>, <span class="hljs-string">&#x27;tar.bz2&#x27;</span>];
            <span class="hljs-keyword">const</span> fileExtension = file.name.split(<span class="hljs-string">&#x27;.&#x27;</span>).pop().toLowerCase();
            
            <span class="hljs-keyword">if</span> (!allowedExtensions.includes(fileExtension) &amp;&amp; 
                !allowedExtensions.includes(file.name.split(<span class="hljs-string">&#x27;.&#x27;</span>).slice(-<span class="hljs-number">2</span>).join(<span class="hljs-string">&#x27;.&#x27;</span>).toLowerCase())) {
                showError(<span class="hljs-string">&#x27;不支持的文件格式。请上传ZIP、TAR、RAR或7Z格式的文件。&#x27;</span>);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-comment">// 验证文件大小 (1GB = 1024MB)</span>
            <span class="hljs-keyword">if</span> (file.size &gt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) {
                showError(<span class="hljs-string">&#x27;文件大小超过1GB限制。&#x27;</span>);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-comment">// 显示进度容器</span>
            progressContainer.style.display = <span class="hljs-string">&#x27;block&#x27;</span>;
            statusMessage.style.display = <span class="hljs-string">&#x27;block&#x27;</span>;
            statusMessage.textContent = <span class="hljs-string">&#x27;正在上传文件...&#x27;</span>;
            
            <span class="hljs-comment">// 创建FormData并上传</span>
            <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> FormData();
            formData.append(<span class="hljs-string">&#x27;file&#x27;</span>, file);
            
            fetch(<span class="hljs-string">&#x27;/upload&#x27;</span>, {
                <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
                <span class="hljs-attr">body</span>: formData
            })
            .then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.json())
            .then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
                <span class="hljs-keyword">if</span> (data.error) {
                    showError(data.error);
                    <span class="hljs-keyword">return</span>;
                }
                
                currentTaskId = data.task_id;
                statusMessage.textContent = <span class="hljs-string">&#x27;文件上传成功，开始处理...&#x27;</span>;
                
                <span class="hljs-comment">// 开始轮询状态</span>
                startStatusPolling();
            })
            .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
                showError(<span class="hljs-string">&#x27;上传失败: &#x27;</span> + error.message);
            });
        }
        
        <span class="hljs-comment">// 开始轮询处理状态</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startStatusPolling</span>(<span class="hljs-params"></span>) </span>{
            statusCheckInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
                fetch(<span class="hljs-string">`/status/<span class="hljs-subst">${currentTaskId}</span>`</span>)
                    .then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.json())
                    .then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
                        <span class="hljs-keyword">if</span> (data.error) {
                            <span class="hljs-built_in">clearInterval</span>(statusCheckInterval);
                            showError(data.error);
                            <span class="hljs-keyword">return</span>;
                        }
                        
                        <span class="hljs-comment">// 更新进度</span>
                        progressFill.style.width = data.progress + <span class="hljs-string">&#x27;%&#x27;</span>;
                        progressText.textContent = data.progress + <span class="hljs-string">&#x27;%&#x27;</span>;
                        statusText.textContent = data.current_step;
                        statusMessage.textContent = data.status;
                        
                        <span class="hljs-comment">// 检查是否完成</span>
                        <span class="hljs-keyword">if</span> (data.status === <span class="hljs-string">&#x27;处理完成&#x27;</span>) {
                            <span class="hljs-built_in">clearInterval</span>(statusCheckInterval);
                            showResult(data);
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.error) {
                            <span class="hljs-built_in">clearInterval</span>(statusCheckInterval);
                            showError(data.error);
                        }
                    })
                    .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
                        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&#x27;状态检查失败:&#x27;</span>, error);
                    });
            }, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 每秒检查一次</span>
        }
        
        <span class="hljs-comment">// 显示结果</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showResult</span>(<span class="hljs-params">data</span>) </span>{
            progressContainer.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;
            resultContainer.style.display = <span class="hljs-string">&#x27;block&#x27;</span>;
            
            <span class="hljs-keyword">if</span> (data.download_url) {
                downloadBtn.href = data.download_url;
            }

            <span class="hljs-comment">// 如果有PDF列表URL，加载PDF文件列表</span>
            <span class="hljs-keyword">if</span> (data.pdf_list_url) {
                loadPdfList(data.pdf_list_url);
            }
        }

        <span class="hljs-comment">// 加载PDF文件列表</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadPdfList</span>(<span class="hljs-params">pdfListUrl</span>) </span>{
            fetch(pdfListUrl)
                .then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.json())
                .then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
                    <span class="hljs-keyword">if</span> (data.error) {
                        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&#x27;加载PDF列表失败:&#x27;</span>, data.error);
                        <span class="hljs-keyword">return</span>;
                    }

                    <span class="hljs-keyword">if</span> (data.pdf_files &amp;&amp; data.pdf_files.length &gt; <span class="hljs-number">0</span>) {
                        displayPdfList(data.pdf_files);
                    }
                })
                .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
                    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&#x27;加载PDF列表失败:&#x27;</span>, error);
                });
        }

        <span class="hljs-comment">// 显示PDF文件列表</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">displayPdfList</span>(<span class="hljs-params">pdfFiles</span>) </span>{
            pdfList.innerHTML = <span class="hljs-string">&#x27;&#x27;</span>;
            
            pdfFiles.forEach(<span class="hljs-function"><span class="hljs-params">pdfFile</span> =&gt;</span> {
                <span class="hljs-keyword">const</span> pdfItem = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&#x27;div&#x27;</span>);
                pdfItem.className = <span class="hljs-string">&#x27;pdf-item&#x27;</span>;
                
                <span class="hljs-keyword">const</span> pdfInfo = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&#x27;div&#x27;</span>);
                pdfInfo.className = <span class="hljs-string">&#x27;pdf-info&#x27;</span>;
                
                <span class="hljs-keyword">const</span> pdfName = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&#x27;div&#x27;</span>);
                pdfName.className = <span class="hljs-string">&#x27;pdf-name&#x27;</span>;
                pdfName.textContent = pdfFile.filename;
                
                <span class="hljs-keyword">const</span> pdfSize = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&#x27;div&#x27;</span>);
                pdfSize.className = <span class="hljs-string">&#x27;pdf-size&#x27;</span>;
                pdfSize.textContent = formatFileSize(pdfFile.size);
                
                pdfInfo.appendChild(pdfName);
                pdfInfo.appendChild(pdfSize);
                
                <span class="hljs-keyword">const</span> downloadBtn = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&#x27;a&#x27;</span>);
                downloadBtn.className = <span class="hljs-string">&#x27;pdf-download-btn&#x27;</span>;
                downloadBtn.href = pdfFile.download_url;
                downloadBtn.textContent = <span class="hljs-string">&#x27;下载&#x27;</span>;
                downloadBtn.target = <span class="hljs-string">&#x27;_blank&#x27;</span>;
                
                pdfItem.appendChild(pdfInfo);
                pdfItem.appendChild(downloadBtn);
                
                pdfList.appendChild(pdfItem);
            });
            
            pdfListContainer.style.display = <span class="hljs-string">&#x27;block&#x27;</span>;
        }

        <span class="hljs-comment">// 格式化文件大小</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">formatFileSize</span>(<span class="hljs-params">bytes</span>) </span>{
            <span class="hljs-keyword">if</span> (bytes === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;0 Bytes&#x27;</span>;
            <span class="hljs-keyword">const</span> k = <span class="hljs-number">1024</span>;
            <span class="hljs-keyword">const</span> sizes = [<span class="hljs-string">&#x27;Bytes&#x27;</span>, <span class="hljs-string">&#x27;KB&#x27;</span>, <span class="hljs-string">&#x27;MB&#x27;</span>, <span class="hljs-string">&#x27;GB&#x27;</span>];
            <span class="hljs-keyword">const</span> i = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.log(bytes) / <span class="hljs-built_in">Math</span>.log(k));
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>((bytes / <span class="hljs-built_in">Math</span>.pow(k, i)).toFixed(<span class="hljs-number">2</span>)) + <span class="hljs-string">&#x27; &#x27;</span> + sizes[i];
        }
        
        <span class="hljs-comment">// 显示错误信息</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showError</span>(<span class="hljs-params">message</span>) </span>{
            progressContainer.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;
            errorMessage.style.display = <span class="hljs-string">&#x27;block&#x27;</span>;
            errorMessage.textContent = message;
        }
        
        <span class="hljs-comment">// 重置UI状态</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resetUI</span>(<span class="hljs-params"></span>) </span>{
            progressContainer.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;
            errorMessage.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;
            resultContainer.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;
            pdfListContainer.style.display = <span class="hljs-string">&#x27;none&#x27;</span>;
            progressFill.style.width = <span class="hljs-string">&#x27;0%&#x27;</span>;
            progressText.textContent = <span class="hljs-string">&#x27;0%&#x27;</span>;
            statusText.textContent = <span class="hljs-string">&#x27;等待开始&#x27;</span>;
            
            <span class="hljs-keyword">if</span> (statusCheckInterval) {
                <span class="hljs-built_in">clearInterval</span>(statusCheckInterval);
            }
        }
        
        <span class="hljs-comment">// 页面加载时重置状态</span>
        <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">&#x27;load&#x27;</span>, resetUI);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 id=utils\compressionpy anchor=true>utils\compressionpy</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> zipfile
<span class="hljs-keyword">import</span> tarfile
<span class="hljs-keyword">import</span> rarfile
<span class="hljs-keyword">import</span> py7zr
<span class="hljs-keyword">import</span> tempfile
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> utils.file_utils <span class="hljs-keyword">import</span> FileUtils

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompressionHandler</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;压缩包处理类&quot;&quot;&quot;</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span>
        self.extracted_files = []
        self.status_callback = <span class="hljs-literal">None</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_status_callback</span>(<span class="hljs-params">self, callback</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;设置状态回调函数&quot;&quot;&quot;</span>
        self.status_callback = callback
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_update_status</span>(<span class="hljs-params">self, message, progress=<span class="hljs-literal">None</span></span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;更新处理状态&quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> self.status_callback:
            self.status_callback(message, progress)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">recursive_extract</span>(<span class="hljs-params">self, file_path, extract_to, depth=<span class="hljs-number">0</span>, max_depth=<span class="hljs-number">10</span></span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;
        递归解压压缩包
        
        Args:
            file_path: 压缩包文件路径
            extract_to: 解压目标目录
            depth: 当前递归深度
            max_depth: 最大递归深度
        
        Returns:
            list: 所有解压出的文件路径列表
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> depth &gt; max_depth:
            self._update_status(<span class="hljs-string">f&quot;达到最大递归深度 <span class="hljs-subst">{max_depth}</span>，停止解压&quot;</span>)
            <span class="hljs-keyword">return</span> []
        
        self._update_status(<span class="hljs-string">f&quot;开始解压: <span class="hljs-subst">{os.path.basename(file_path)}</span>&quot;</span>)
        
        extracted_files = []
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 根据文件类型选择解压方法</span>
            <span class="hljs-keyword">if</span> zipfile.is_zipfile(file_path):
                extracted_files.extend(self._extract_zip(file_path, extract_to))
            <span class="hljs-keyword">elif</span> tarfile.is_tarfile(file_path):
                extracted_files.extend(self._extract_tar(file_path, extract_to))
            <span class="hljs-keyword">elif</span> file_path.lower().endswith(<span class="hljs-string">&#x27;.rar&#x27;</span>):
                extracted_files.extend(self._extract_rar(file_path, extract_to))
            <span class="hljs-keyword">elif</span> file_path.lower().endswith(<span class="hljs-string">&#x27;.7z&#x27;</span>):
                extracted_files.extend(self._extract_7z(file_path, extract_to))
            <span class="hljs-keyword">else</span>:
                self._update_status(<span class="hljs-string">f&quot;不支持的压缩格式: <span class="hljs-subst">{file_path}</span>&quot;</span>)
                <span class="hljs-keyword">return</span> []
            
            <span class="hljs-comment"># 检查解压出的文件是否也是压缩包</span>
            <span class="hljs-keyword">for</span> extracted_file <span class="hljs-keyword">in</span> extracted_files[:]:  <span class="hljs-comment"># 使用副本进行迭代</span>
                <span class="hljs-keyword">if</span> FileUtils.is_compressed_file(extracted_file):
                    self._update_status(<span class="hljs-string">f&quot;发现嵌套压缩包: <span class="hljs-subst">{os.path.basename(extracted_file)}</span>&quot;</span>)
                    
                    <span class="hljs-comment"># 创建子目录用于解压嵌套压缩包</span>
                    nested_extract_to = os.path.join(
                        extract_to, 
                        <span class="hljs-string">f&quot;nested_<span class="hljs-subst">{Path(extracted_file).stem}</span>&quot;</span>
                    )
                    os.makedirs(nested_extract_to, exist_ok=<span class="hljs-literal">True</span>)
                    
                    <span class="hljs-comment"># 递归解压</span>
                    nested_files = self.recursive_extract(
                        extracted_file, nested_extract_to, depth + <span class="hljs-number">1</span>, max_depth
                    )
                    extracted_files.extend(nested_files)
                    
                    <span class="hljs-comment"># 删除已解压的嵌套压缩包文件</span>
                    <span class="hljs-keyword">try</span>:
                        os.remove(extracted_file)
                    <span class="hljs-keyword">except</span>:
                        <span class="hljs-keyword">pass</span>
            
            self._update_status(<span class="hljs-string">f&quot;解压完成: <span class="hljs-subst">{os.path.basename(file_path)}</span>&quot;</span>, progress=<span class="hljs-number">100</span>)
            <span class="hljs-keyword">return</span> extracted_files
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self._update_status(<span class="hljs-string">f&quot;解压失败 <span class="hljs-subst">{file_path}</span>: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>)
            <span class="hljs-keyword">return</span> []
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_extract_zip</span>(<span class="hljs-params">self, file_path, extract_to</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;解压ZIP文件&quot;&quot;&quot;</span>
        extracted_files = []
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> zipfile.ZipFile(file_path, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> zip_ref:
                file_list = zip_ref.namelist()
                total_files = <span class="hljs-built_in">len</span>(file_list)
                
                <span class="hljs-keyword">for</span> i, file_info <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(file_list):
                    <span class="hljs-comment"># 跳过目录</span>
                    <span class="hljs-keyword">if</span> file_info.endswith(<span class="hljs-string">&#x27;/&#x27;</span>):
                        <span class="hljs-keyword">continue</span>
                    
                    <span class="hljs-comment"># 解压文件</span>
                    zip_ref.extract(file_info, extract_to)
                    extracted_path = os.path.join(extract_to, file_info)
                    extracted_files.append(extracted_path)
                    
                    <span class="hljs-comment"># 更新进度</span>
                    progress = (i + <span class="hljs-number">1</span>) / total_files * <span class="hljs-number">100</span>
                    self._update_status(<span class="hljs-string">f&quot;解压ZIP文件: <span class="hljs-subst">{file_info}</span>&quot;</span>, progress)
                
            <span class="hljs-keyword">return</span> extracted_files
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f&quot;ZIP解压失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_extract_tar</span>(<span class="hljs-params">self, file_path, extract_to</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;解压TAR文件（包括.tar.gz, .tar.bz2）&quot;&quot;&quot;</span>
        extracted_files = []
        <span class="hljs-keyword">try</span>:
            mode = <span class="hljs-string">&#x27;r&#x27;</span>
            <span class="hljs-keyword">if</span> file_path.endswith(<span class="hljs-string">&#x27;.gz&#x27;</span>):
                mode = <span class="hljs-string">&#x27;r:gz&#x27;</span>
            <span class="hljs-keyword">elif</span> file_path.endswith(<span class="hljs-string">&#x27;.bz2&#x27;</span>):
                mode = <span class="hljs-string">&#x27;r:bz2&#x27;</span>
            
            <span class="hljs-keyword">with</span> tarfile.<span class="hljs-built_in">open</span>(file_path, mode) <span class="hljs-keyword">as</span> tar_ref:
                members = tar_ref.getmembers()
                total_files = <span class="hljs-built_in">len</span>(members)
                
                <span class="hljs-keyword">for</span> i, member <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(members):
                    <span class="hljs-comment"># 跳过目录</span>
                    <span class="hljs-keyword">if</span> member.isdir():
                        <span class="hljs-keyword">continue</span>
                    
                    <span class="hljs-comment"># 解压文件</span>
                    tar_ref.extract(member, extract_to)
                    extracted_path = os.path.join(extract_to, member.name)
                    extracted_files.append(extracted_path)
                    
                    <span class="hljs-comment"># 更新进度</span>
                    progress = (i + <span class="hljs-number">1</span>) / total_files * <span class="hljs-number">100</span>
                    self._update_status(<span class="hljs-string">f&quot;解压TAR文件: <span class="hljs-subst">{member.name}</span>&quot;</span>, progress)
                
            <span class="hljs-keyword">return</span> extracted_files
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f&quot;TAR解压失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_extract_rar</span>(<span class="hljs-params">self, file_path, extract_to</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;解压RAR文件&quot;&quot;&quot;</span>
        extracted_files = []
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> rarfile.RarFile(file_path) <span class="hljs-keyword">as</span> rar_ref:
                file_list = rar_ref.namelist()
                total_files = <span class="hljs-built_in">len</span>(file_list)
                
                <span class="hljs-keyword">for</span> i, file_info <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(file_list):
                    <span class="hljs-comment"># 跳过目录</span>
                    <span class="hljs-keyword">if</span> file_info.endswith(<span class="hljs-string">&#x27;/&#x27;</span>) <span class="hljs-keyword">or</span> file_info.endswith(<span class="hljs-string">&#x27;\\&#x27;</span>):
                        <span class="hljs-keyword">continue</span>
                    
                    <span class="hljs-comment"># 解压文件</span>
                    rar_ref.extract(file_info, extract_to)
                    extracted_path = os.path.join(extract_to, file_info)
                    extracted_files.append(extracted_path)
                    
                    <span class="hljs-comment"># 更新进度</span>
                    progress = (i + <span class="hljs-number">1</span>) / total_files * <span class="hljs-number">100</span>
                    self._update_status(<span class="hljs-string">f&quot;解压RAR文件: <span class="hljs-subst">{file_info}</span>&quot;</span>, progress)
                
            <span class="hljs-keyword">return</span> extracted_files
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f&quot;RAR解压失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_extract_7z</span>(<span class="hljs-params">self, file_path, extract_to</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;解压7z文件&quot;&quot;&quot;</span>
        extracted_files = []
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> py7zr.SevenZipFile(file_path, mode=<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> seven_zip_ref:
                file_list = seven_zip_ref.getnames()
                total_files = <span class="hljs-built_in">len</span>(file_list)
                
                <span class="hljs-keyword">for</span> i, file_info <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(file_list):
                    <span class="hljs-comment"># 解压文件</span>
                    seven_zip_ref.extract(targets=[file_info], path=extract_to)
                    extracted_path = os.path.join(extract_to, file_info)
                    extracted_files.append(extracted_path)
                    
                    <span class="hljs-comment"># 更新进度</span>
                    progress = (i + <span class="hljs-number">1</span>) / total_files * <span class="hljs-number">100</span>
                    self._update_status(<span class="hljs-string">f&quot;解压7z文件: <span class="hljs-subst">{file_info}</span>&quot;</span>, progress)
                
            <span class="hljs-keyword">return</span> extracted_files
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f&quot;7z解压失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>)
</code></pre>
<h4 id=utils\file_utilspy anchor=true>utils\file_utilspy</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">import</span> mimetypes
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> config

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileUtils</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;文件处理工具类&quot;&quot;&quot;</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allowed_file</span>(<span class="hljs-params">filename, allowed_extensions</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;检查文件扩展名是否允许&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> filename <span class="hljs-keyword">and</span> \
               filename.rsplit(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>].lower() <span class="hljs-keyword">in</span> allowed_extensions
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_file_type</span>(<span class="hljs-params">file_path</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;使用mimetypes检测文件类型&quot;&quot;&quot;</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 使用mimetypes库检测文件类型</span>
            file_type, encoding = mimetypes.guess_type(file_path)
            <span class="hljs-keyword">return</span> file_type
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;检测文件类型失败: <span class="hljs-subst">{e}</span>&quot;</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_compressed_file</span>(<span class="hljs-params">file_path</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;检查是否为压缩文件&quot;&quot;&quot;</span>
        file_type = FileUtils.get_file_type(file_path)
        <span class="hljs-keyword">if</span> file_type:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">any</span>(compressed_type <span class="hljs-keyword">in</span> file_type <span class="hljs-keyword">for</span> compressed_type <span class="hljs-keyword">in</span> [
                <span class="hljs-string">&#x27;application/zip&#x27;</span>,
                <span class="hljs-string">&#x27;application/x-tar&#x27;</span>,
                <span class="hljs-string">&#x27;application/gzip&#x27;</span>,
                <span class="hljs-string">&#x27;application/x-bzip2&#x27;</span>,
                <span class="hljs-string">&#x27;application/x-rar&#x27;</span>,
                <span class="hljs-string">&#x27;application/x-7z-compressed&#x27;</span>
            ])
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_image_file</span>(<span class="hljs-params">file_path</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;检查是否为图片文件&quot;&quot;&quot;</span>
        file_type = FileUtils.get_file_type(file_path)
        <span class="hljs-keyword">if</span> file_type:
            <span class="hljs-keyword">return</span> file_type.startswith(<span class="hljs-string">&#x27;image/&#x27;</span>)
        <span class="hljs-comment"># 备用检查：通过文件扩展名</span>
        ext = Path(file_path).suffix.lower()[<span class="hljs-number">1</span>:]
        <span class="hljs-keyword">return</span> ext <span class="hljs-keyword">in</span> config[<span class="hljs-string">&#x27;default&#x27;</span>].ALLOWED_IMAGE_EXTENSIONS
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">natural_sort_key</span>(<span class="hljs-params">s</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;自然排序键函数&quot;&quot;&quot;</span>
        <span class="hljs-keyword">import</span> re
        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">int</span>(text) <span class="hljs-keyword">if</span> text.isdigit() <span class="hljs-keyword">else</span> text.lower()
                <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> re.split(<span class="hljs-string">r&#x27;(\d+)&#x27;</span>, <span class="hljs-built_in">str</span>(s))]
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_directories</span>():</span>
        <span class="hljs-string">&quot;&quot;&quot;创建必要的目录&quot;&quot;&quot;</span>
        directories = [
            config[<span class="hljs-string">&#x27;default&#x27;</span>].UPLOAD_FOLDER,
            config[<span class="hljs-string">&#x27;default&#x27;</span>].TEMP_FOLDER,
            config[<span class="hljs-string">&#x27;default&#x27;</span>].OUTPUT_FOLDER
        ]
        
        <span class="hljs-keyword">for</span> directory <span class="hljs-keyword">in</span> directories:
            os.makedirs(directory, exist_ok=<span class="hljs-literal">True</span>)
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cleanup_old_files</span>(<span class="hljs-params">directory, hours_old=<span class="hljs-number">24</span></span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;清理指定目录中超过指定时间的文件&quot;&quot;&quot;</span>
        <span class="hljs-keyword">import</span> time
        current_time = time.time()
        
        <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> os.listdir(directory):
            file_path = os.path.join(directory, filename)
            <span class="hljs-keyword">if</span> os.path.isfile(file_path):
                file_time = os.path.getmtime(file_path)
                <span class="hljs-keyword">if</span> current_time - file_time &gt; hours_old * <span class="hljs-number">3600</span>:
                    <span class="hljs-keyword">try</span>:
                        os.remove(file_path)
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;已清理文件: <span class="hljs-subst">{file_path}</span>&quot;</span>)
                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;清理文件失败 <span class="hljs-subst">{file_path}</span>: <span class="hljs-subst">{e}</span>&quot;</span>)
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_file_size</span>(<span class="hljs-params">file_path</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;获取文件大小（MB）&quot;&quot;&quot;</span>
        <span class="hljs-keyword">try</span>:
            size_bytes = os.path.getsize(file_path)
            <span class="hljs-keyword">return</span> size_bytes / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)  <span class="hljs-comment"># 转换为MB</span>
        <span class="hljs-keyword">except</span> OSError:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">safe_remove</span>(<span class="hljs-params">path</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;安全删除文件或目录&quot;&quot;&quot;</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">if</span> os.path.isfile(path):
                os.remove(path)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;已删除文件: <span class="hljs-subst">{path}</span>&quot;</span>)
            <span class="hljs-keyword">elif</span> os.path.isdir(path):
                shutil.rmtree(path)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;已删除目录: <span class="hljs-subst">{path}</span>&quot;</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;删除失败 <span class="hljs-subst">{path}</span>: <span class="hljs-subst">{e}</span>&quot;</span>)

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cleanup_task_files</span>(<span class="hljs-params">task_id, upload_folder, temp_folder, output_folder</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;清理指定任务的所有相关文件&quot;&quot;&quot;</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;开始清理任务 <span class="hljs-subst">{task_id}</span> 的文件...&quot;</span>)
        
        <span class="hljs-comment"># 清理上传文件</span>
        <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> os.listdir(upload_folder):
            <span class="hljs-keyword">if</span> filename.startswith(task_id):
                file_path = os.path.join(upload_folder, filename)
                FileUtils.safe_remove(file_path)
        
        <span class="hljs-comment"># 清理临时目录</span>
        temp_dir = os.path.join(temp_folder, <span class="hljs-string">f&quot;temp_<span class="hljs-subst">{task_id}</span>&quot;</span>)
        <span class="hljs-keyword">if</span> os.path.exists(temp_dir):
            FileUtils.safe_remove(temp_dir)
        
        <span class="hljs-comment"># 清理PDF输出目录</span>
        pdf_dir = os.path.join(output_folder, <span class="hljs-string">f&quot;pdfs_<span class="hljs-subst">{task_id}</span>&quot;</span>)
        <span class="hljs-keyword">if</span> os.path.exists(pdf_dir):
            FileUtils.safe_remove(pdf_dir)
        
        <span class="hljs-comment"># 清理ZIP输出文件</span>
        zip_file = os.path.join(output_folder, <span class="hljs-string">f&quot;result_<span class="hljs-subst">{task_id}</span>.zip&quot;</span>)
        <span class="hljs-keyword">if</span> os.path.exists(zip_file):
            FileUtils.safe_remove(zip_file)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;任务 <span class="hljs-subst">{task_id}</span> 文件清理完成&quot;</span>)

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cleanup_all_temp_files</span>():</span>
        <span class="hljs-string">&quot;&quot;&quot;清理所有临时文件&quot;&quot;&quot;</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始清理所有临时文件...&quot;</span>)
        
        config_obj = config[<span class="hljs-string">&#x27;default&#x27;</span>]
        
        <span class="hljs-comment"># 清理上传文件夹</span>
        <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> os.listdir(config_obj.UPLOAD_FOLDER):
            file_path = os.path.join(config_obj.UPLOAD_FOLDER, filename)
            FileUtils.safe_remove(file_path)
        
        <span class="hljs-comment"># 清理临时文件夹</span>
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> os.listdir(config_obj.TEMP_FOLDER):
            item_path = os.path.join(config_obj.TEMP_FOLDER, item)
            FileUtils.safe_remove(item_path)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;所有临时文件清理完成&quot;</span>)
</code></pre>
<h4 id=utils\image_processorpy anchor=true>utils\image_processorpy</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">from</span> utils.file_utils <span class="hljs-keyword">import</span> FileUtils

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageProcessor</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;图片处理类&quot;&quot;&quot;</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span>
        self.status_callback = <span class="hljs-literal">None</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_status_callback</span>(<span class="hljs-params">self, callback</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;设置状态回调函数&quot;&quot;&quot;</span>
        self.status_callback = callback
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_update_status</span>(<span class="hljs-params">self, message, progress=<span class="hljs-literal">None</span></span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;更新处理状态&quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> self.status_callback:
            self.status_callback(message, progress)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collect_and_sort_images</span>(<span class="hljs-params">self, root_dir</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;
        收集并排序图片文件，按文件夹分组
        
        Args:
            root_dir: 根目录路径
            
        Returns:
            dict: 按文件夹分组的图片路径字典 {folder_path: [sorted_image_paths]}
        &quot;&quot;&quot;</span>
        self._update_status(<span class="hljs-string">&quot;开始收集图片文件...&quot;</span>)
        
        image_groups = {}
        
        <span class="hljs-comment"># 遍历目录结构</span>
        <span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(root_dir):
            image_files = []
            
            <span class="hljs-comment"># 过滤图片文件</span>
            <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:
                file_path = os.path.join(root, file)
                <span class="hljs-keyword">if</span> FileUtils.is_image_file(file_path):
                    image_files.append(file_path)
            
            <span class="hljs-comment"># 如果有图片文件，按自然顺序排序</span>
            <span class="hljs-keyword">if</span> image_files:
                <span class="hljs-comment"># 使用自然排序</span>
                image_files.sort(key=FileUtils.natural_sort_key)
                image_groups[root] = image_files
        
        self._update_status(<span class="hljs-string">f&quot;找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(image_groups)}</span> 个包含图片的文件夹&quot;</span>)
        <span class="hljs-keyword">return</span> image_groups
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_to_supported_format</span>(<span class="hljs-params">self, image_path, output_dir</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;
        将图片转换为PDF支持的格式
        
        Args:
            image_path: 原始图片路径
            output_dir: 输出目录
            
        Returns:
            str: 转换后的图片路径
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 打开图片</span>
            <span class="hljs-keyword">with</span> Image.<span class="hljs-built_in">open</span>(image_path) <span class="hljs-keyword">as</span> img:
                <span class="hljs-comment"># 获取文件信息</span>
                filename = Path(image_path).stem
                output_path = os.path.join(output_dir, <span class="hljs-string">f&quot;<span class="hljs-subst">{filename}</span>.png&quot;</span>)
                
                <span class="hljs-comment"># 如果已经是PNG格式且不需要转换，直接返回原路径</span>
                <span class="hljs-keyword">if</span> image_path.lower().endswith(<span class="hljs-string">&#x27;.png&#x27;</span>):
                    <span class="hljs-keyword">return</span> image_path
                
                <span class="hljs-comment"># 转换图片格式为PNG（PDF生成最兼容的格式）</span>
                <span class="hljs-keyword">if</span> img.mode <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-string">&#x27;RGBA&#x27;</span>):
                    <span class="hljs-comment"># 处理带透明度的图片</span>
                    img = img.convert(<span class="hljs-string">&#x27;RGBA&#x27;</span>)
                <span class="hljs-keyword">else</span>:
                    img = img.convert(<span class="hljs-string">&#x27;RGB&#x27;</span>)
                
                <span class="hljs-comment"># 保存为PNG格式</span>
                img.save(output_path, <span class="hljs-string">&#x27;PNG&#x27;</span>, optimize=<span class="hljs-literal">True</span>)
                
                <span class="hljs-keyword">return</span> output_path
                
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self._update_status(<span class="hljs-string">f&quot;图片转换失败 <span class="hljs-subst">{image_path}</span>: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">optimize_image_for_pdf</span>(<span class="hljs-params">self, image_path, max_size=(<span class="hljs-params"><span class="hljs-number">2480</span>, <span class="hljs-number">3508</span></span>)</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;
        优化图片以适应PDF页面（A4尺寸）
        
        Args:
            image_path: 图片路径
            max_size: 最大尺寸 (宽, 高)，默认A4尺寸(2480x3508像素)
            
        Returns:
            str: 优化后的图片路径
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> Image.<span class="hljs-built_in">open</span>(image_path) <span class="hljs-keyword">as</span> img:
                <span class="hljs-comment"># 获取原始尺寸</span>
                original_width, original_height = img.size
                
                <span class="hljs-comment"># 计算缩放比例</span>
                width_ratio = max_size[<span class="hljs-number">0</span>] / original_width
                height_ratio = max_size[<span class="hljs-number">1</span>] / original_height
                scale_ratio = <span class="hljs-built_in">min</span>(width_ratio, height_ratio, <span class="hljs-number">1.0</span>)  <span class="hljs-comment"># 不超过原始尺寸</span>
                
                <span class="hljs-comment"># 如果不需要缩放，直接返回</span>
                <span class="hljs-keyword">if</span> scale_ratio &gt;= <span class="hljs-number">1.0</span>:
                    <span class="hljs-keyword">return</span> image_path
                
                <span class="hljs-comment"># 计算新尺寸</span>
                new_width = <span class="hljs-built_in">int</span>(original_width * scale_ratio)
                new_height = <span class="hljs-built_in">int</span>(original_height * scale_ratio)
                
                <span class="hljs-comment"># 调整图片大小</span>
                resized_img = img.resize((new_width, new_height), Image.Resampling.LANCZOS)
                
                <span class="hljs-comment"># 保存优化后的图片（覆盖原文件）</span>
                resized_img.save(image_path, optimize=<span class="hljs-literal">True</span>)
                
                self._update_status(<span class="hljs-string">f&quot;优化图片尺寸: <span class="hljs-subst">{original_width}</span>x<span class="hljs-subst">{original_height}</span> -&gt; <span class="hljs-subst">{new_width}</span>x<span class="hljs-subst">{new_height}</span>&quot;</span>)
                <span class="hljs-keyword">return</span> image_path
                
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self._update_status(<span class="hljs-string">f&quot;图片优化失败 <span class="hljs-subst">{image_path}</span>: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>)
            <span class="hljs-keyword">return</span> image_path  <span class="hljs-comment"># 返回原路径，不中断流程</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_image_group</span>(<span class="hljs-params">self, image_group, output_dir</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;
        处理一组图片，进行格式转换和优化
        
        Args:
            image_group: 图片路径列表
            output_dir: 输出目录
            
        Returns:
            list: 处理后的图片路径列表
        &quot;&quot;&quot;</span>
        processed_images = []
        total_images = <span class="hljs-built_in">len</span>(image_group)
        
        <span class="hljs-keyword">for</span> i, image_path <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(image_group):
            <span class="hljs-comment"># 更新进度</span>
            progress = (i + <span class="hljs-number">1</span>) / total_images * <span class="hljs-number">100</span>
            self._update_status(<span class="hljs-string">f&quot;处理图片: <span class="hljs-subst">{Path(image_path).name}</span>&quot;</span>, progress)
            
            <span class="hljs-comment"># 转换图片格式</span>
            converted_path = self.convert_to_supported_format(image_path, output_dir)
            <span class="hljs-keyword">if</span> converted_path:
                <span class="hljs-comment"># 优化图片尺寸</span>
                optimized_path = self.optimize_image_for_pdf(converted_path)
                processed_images.append(optimized_path)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 如果转换失败，尝试直接使用原图</span>
                self._update_status(<span class="hljs-string">f&quot;使用原图: <span class="hljs-subst">{Path(image_path).name}</span>&quot;</span>)
                processed_images.append(image_path)
        
        <span class="hljs-keyword">return</span> processed_images
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_image_info</span>(<span class="hljs-params">self, image_path</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;
        获取图片信息
        
        Args:
            image_path: 图片路径
            
        Returns:
            dict: 图片信息字典
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> Image.<span class="hljs-built_in">open</span>(image_path) <span class="hljs-keyword">as</span> img:
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">&#x27;format&#x27;</span>: img.<span class="hljs-built_in">format</span>,
                    <span class="hljs-string">&#x27;size&#x27;</span>: img.size,
                    <span class="hljs-string">&#x27;mode&#x27;</span>: img.mode,
                    <span class="hljs-string">&#x27;filename&#x27;</span>: Path(image_path).name
                }
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">&#x27;format&#x27;</span>: <span class="hljs-string">&#x27;Unknown&#x27;</span>,
                <span class="hljs-string">&#x27;size&#x27;</span>: (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
                <span class="hljs-string">&#x27;mode&#x27;</span>: <span class="hljs-string">&#x27;Unknown&#x27;</span>,
                <span class="hljs-string">&#x27;filename&#x27;</span>: Path(image_path).name,
                <span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-built_in">str</span>(e)
            }
</code></pre>
<h4 id=utils\pdf_generatorpy anchor=true>utils\pdf_generatorpy</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> img2pdf
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> utils.file_utils <span class="hljs-keyword">import</span> FileUtils

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PDFGenerator</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;PDF生成类&quot;&quot;&quot;</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span>
        self.status_callback = <span class="hljs-literal">None</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_status_callback</span>(<span class="hljs-params">self, callback</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;设置状态回调函数&quot;&quot;&quot;</span>
        self.status_callback = callback
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_update_status</span>(<span class="hljs-params">self, message, progress=<span class="hljs-literal">None</span></span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;更新处理状态&quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> self.status_callback:
            self.status_callback(message, progress)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_pdf_from_images</span>(<span class="hljs-params">self, image_paths, output_pdf_path, page_size=<span class="hljs-string">&#x27;A4&#x27;</span></span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;
        从图片列表生成PDF
        
        Args:
            image_paths: 图片路径列表
            output_pdf_path: 输出PDF路径
            page_size: 页面尺寸
            
        Returns:
            bool: 是否成功生成
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image_paths:
                self._update_status(<span class="hljs-string">&quot;没有图片可生成PDF&quot;</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            
            self._update_status(<span class="hljs-string">f&quot;开始生成PDF: <span class="hljs-subst">{Path(output_pdf_path).name}</span>&quot;</span>)
            
            <span class="hljs-comment"># 验证所有图片文件都存在</span>
            valid_images = []
            <span class="hljs-keyword">for</span> img_path <span class="hljs-keyword">in</span> image_paths:
                <span class="hljs-keyword">if</span> os.path.exists(img_path):
                    valid_images.append(img_path)
                <span class="hljs-keyword">else</span>:
                    self._update_status(<span class="hljs-string">f&quot;图片文件不存在: <span class="hljs-subst">{img_path}</span>&quot;</span>)
            
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid_images:
                self._update_status(<span class="hljs-string">&quot;没有有效的图片文件&quot;</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            
            <span class="hljs-comment"># 设置PDF页面参数</span>
            pdf_layout_fun = self._get_pdf_layout_function(page_size)
            
            <span class="hljs-comment"># 生成PDF</span>
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(output_pdf_path, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> pdf_file:
                pdf_file.write(img2pdf.convert(
                    valid_images,
                    layout_fun=pdf_layout_fun
                ))
            
            <span class="hljs-comment"># 验证生成的PDF文件</span>
            <span class="hljs-keyword">if</span> os.path.exists(output_pdf_path) <span class="hljs-keyword">and</span> os.path.getsize(output_pdf_path) &gt; <span class="hljs-number">0</span>:
                self._update_status(<span class="hljs-string">f&quot;PDF生成成功: <span class="hljs-subst">{Path(output_pdf_path).name}</span>&quot;</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                self._update_status(<span class="hljs-string">&quot;PDF文件生成失败&quot;</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
                
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self._update_status(<span class="hljs-string">f&quot;PDF生成失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_pdf_layout_function</span>(<span class="hljs-params">self, page_size</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;获取PDF布局函数&quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> page_size.upper() == <span class="hljs-string">&#x27;A4&#x27;</span>:
            <span class="hljs-comment"># A4尺寸：210mm x 297mm</span>
            <span class="hljs-keyword">return</span> img2pdf.get_layout_fun((img2pdf.mm_to_pt(<span class="hljs-number">210</span>), img2pdf.mm_to_pt(<span class="hljs-number">297</span>)))
        <span class="hljs-keyword">elif</span> page_size.upper() == <span class="hljs-string">&#x27;LETTER&#x27;</span>:
            <span class="hljs-comment"># Letter尺寸：215.9mm x 279.4mm</span>
            <span class="hljs-keyword">return</span> img2pdf.get_layout_fun((img2pdf.mm_to_pt(<span class="hljs-number">215.9</span>), img2pdf.mm_to_pt(<span class="hljs-number">279.4</span>)))
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 默认使用A4</span>
            <span class="hljs-keyword">return</span> img2pdf.get_layout_fun((img2pdf.mm_to_pt(<span class="hljs-number">210</span>), img2pdf.mm_to_pt(<span class="hljs-number">297</span>)))
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_pdfs_by_folder</span>(<span class="hljs-params">self, image_groups, output_dir, base_name=<span class="hljs-string">&quot;output&quot;</span></span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;
        按文件夹分组生成多个PDF
        
        Args:
            image_groups: 按文件夹分组的图片字典 {folder_path: [image_paths]}
            output_dir: 输出目录
            base_name: 基础文件名
            
        Returns:
            dict: 生成的PDF文件路径字典 {folder_name: pdf_path}
        &quot;&quot;&quot;</span>
        generated_pdfs = {}
        total_groups = <span class="hljs-built_in">len</span>(image_groups)
        
        <span class="hljs-keyword">for</span> i, (folder_path, image_paths) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(image_groups.items()):
            <span class="hljs-comment"># 更新进度</span>
            progress = (i + <span class="hljs-number">1</span>) / total_groups * <span class="hljs-number">100</span>
            folder_name = Path(folder_path).name <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;root&quot;</span>
            self._update_status(<span class="hljs-string">f&quot;生成PDF: <span class="hljs-subst">{folder_name}</span>&quot;</span>, progress)
            
            <span class="hljs-comment"># 生成PDF文件名</span>
            pdf_filename = <span class="hljs-string">f&quot;<span class="hljs-subst">{base_name}</span>_<span class="hljs-subst">{folder_name}</span>.pdf&quot;</span>
            pdf_path = os.path.join(output_dir, pdf_filename)
            
            <span class="hljs-comment"># 生成PDF</span>
            <span class="hljs-keyword">if</span> self.generate_pdf_from_images(image_paths, pdf_path):
                generated_pdfs[folder_name] = pdf_path
        
        <span class="hljs-keyword">return</span> generated_pdfs
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_pdf_package</span>(<span class="hljs-params">self, pdf_files, output_zip_path</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;
        将多个PDF文件打包成ZIP文件
        
        Args:
            pdf_files: PDF文件路径列表
            output_zip_path: 输出ZIP文件路径
            
        Returns:
            bool: 是否成功打包
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">import</span> zipfile
        
        <span class="hljs-keyword">try</span>:
            self._update_status(<span class="hljs-string">&quot;正在打包PDF文件...&quot;</span>)
            
            <span class="hljs-keyword">with</span> zipfile.ZipFile(output_zip_path, <span class="hljs-string">&#x27;w&#x27;</span>, zipfile.ZIP_DEFLATED) <span class="hljs-keyword">as</span> zipf:
                <span class="hljs-keyword">for</span> pdf_path <span class="hljs-keyword">in</span> pdf_files:
                    <span class="hljs-keyword">if</span> os.path.exists(pdf_path):
                        <span class="hljs-comment"># 使用相对路径存储</span>
                        arcname = Path(pdf_path).name
                        zipf.write(pdf_path, arcname)
            
            <span class="hljs-comment"># 验证生成的ZIP文件</span>
            <span class="hljs-keyword">if</span> os.path.exists(output_zip_path) <span class="hljs-keyword">and</span> os.path.getsize(output_zip_path) &gt; <span class="hljs-number">0</span>:
                self._update_status(<span class="hljs-string">f&quot;PDF打包成功: <span class="hljs-subst">{Path(output_zip_path).name}</span>&quot;</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                self._update_status(<span class="hljs-string">&quot;PDF打包失败&quot;</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
                
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self._update_status(<span class="hljs-string">f&quot;PDF打包失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>&quot;</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_pdf_info</span>(<span class="hljs-params">self, pdf_path</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;
        获取PDF文件信息
        
        Args:
            pdf_path: PDF文件路径
            
        Returns:
            dict: PDF信息字典
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">try</span>:
            file_size = os.path.getsize(pdf_path)
            file_size_mb = file_size / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)
            
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">&#x27;filename&#x27;</span>: Path(pdf_path).name,
                <span class="hljs-string">&#x27;file_size&#x27;</span>: file_size,
                <span class="hljs-string">&#x27;file_size_mb&#x27;</span>: <span class="hljs-built_in">round</span>(file_size_mb, <span class="hljs-number">2</span>),
                <span class="hljs-string">&#x27;created_time&#x27;</span>: os.path.getctime(pdf_path)
            }
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">&#x27;filename&#x27;</span>: Path(pdf_path).name,
                <span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-built_in">str</span>(e)
            }
</code></pre>
<h4 id=utils\__init__py anchor=true>utils__init__py</h4>
<p><a href="#Contents">to top</a></p>
<pre><code class="language-python"><span class="hljs-comment"># 工具模块包</span>
</code></pre>
</article>

            
        <script src="file://C:\Users\14530\AppData\Roaming\npm\node_modules\repo-to-pdf\html5bp/js/vendor/jquery-1.10.2.min.js"></script>
        <script src="file://C:\Users\14530\AppData\Roaming\npm\node_modules\repo-to-pdf\html5bp/js/plugins.js"></script>
        <script src="file://C:\Users\14530\AppData\Roaming\npm\node_modules\repo-to-pdf\html5bp/js/main.js"></script>
    </body>
</html>
